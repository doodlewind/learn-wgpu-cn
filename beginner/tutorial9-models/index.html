<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>åŠ è½½æ¨¡å‹ | å­¦ä¹  Wgpu</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.4.0">
    
    <meta property="article:modified_time" content="2022-04-30T14:50:47.000Z"><meta property="og:site_name" content="å­¦ä¹  Wgpu"><meta property="og:title" content="åŠ è½½æ¨¡å‹"><meta property="og:type" content="website"><meta property="og:url" content="/beginner/tutorial9-models/"><meta name="twitter:title" content="åŠ è½½æ¨¡å‹"><meta name="twitter:url" content="/beginner/tutorial9-models/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:data2" content="Benjamin Hansen"><meta name="twitter:creator" content="https://twitter.com/sotrh760">
    <link rel="preload" href="/learn-wgpu-cn/assets/css/0.styles.2f5dce02.css" as="style"><link rel="preload" href="/learn-wgpu-cn/assets/js/app.4a62b3f5.js" as="script"><link rel="preload" href="/learn-wgpu-cn/assets/js/4.9ddd2a75.js" as="script"><link rel="preload" href="/learn-wgpu-cn/assets/js/11.1001c632.js" as="script"><link rel="preload" href="/learn-wgpu-cn/assets/js/25.5a7a1f31.js" as="script"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/1.e1054b07.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/10.1b6d1cf6.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/12.7e1fa0ed.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/13.c591e8de.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/14.1821141e.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/15.795372a4.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/16.14679006.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/17.36012420.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/18.3941048f.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/19.f3f8b412.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/2.ce803252.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/20.140d2648.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/21.a801933f.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/22.d1c5beb9.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/23.ffb83767.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/24.6a0d1e12.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/26.a5048f3d.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/27.14e287f6.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/28.0d853b3b.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/29.c45319b3.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/30.f4b97050.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/31.ab88ef7b.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/32.21765d0f.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/33.4daba1cc.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/34.9d2cb00a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/35.45887274.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/36.c0c5124a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/5.9e56ad9a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/6.8eb3b610.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/7.e1535c20.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/8.a6ef1f77.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/9.62cbd082.js">
    <link rel="stylesheet" href="/learn-wgpu-cn/assets/css/0.styles.2f5dce02.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu-cn/" class="home-link router-link-active"><!----> <span class="site-name">å­¦ä¹  Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu-cn/" class="sidebar-link">ä»‹ç»</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>å…¥é—¨</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-cn/beginner/tutorial1-window/" class="sidebar-link">ä¾èµ–ä¸çª—å£</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial2-surface/" class="sidebar-link">ä½¿ç”¨ Surface</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial3-pipeline/" class="sidebar-link">ä½¿ç”¨ Pipeline</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial4-buffer/" class="sidebar-link">é¡¶ç‚¹ç¼“å†²åŒºä¸ç´¢å¼•ç¼“å†²åŒº</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial5-textures/" class="sidebar-link">çº¹ç†ä¸ BindGroup</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial6-uniforms/" class="sidebar-link">Uniform ç¼“å†²åŒºä¸ 3D ç›¸æœº</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial7-instancing/" class="sidebar-link">å®ä¾‹åŒ–ç»˜åˆ¶</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial8-depth/" class="sidebar-link">æ·±åº¦ç¼“å†²åŒº</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial9-models/" class="active sidebar-link">åŠ è½½æ¨¡å‹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial9-models/#ä»èµ„æºç›®å½•ä¸­è·å–æ–‡ä»¶" class="sidebar-link">ä»èµ„æºç›®å½•ä¸­è·å–æ–‡ä»¶</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial9-models/#ä½¿ç”¨-tobj-åŠ è½½æ¨¡å‹" class="sidebar-link">ä½¿ç”¨ TOBJ åŠ è½½æ¨¡å‹</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial9-models/#æ¸²æŸ“ç½‘æ ¼" class="sidebar-link">æ¸²æŸ“ç½‘æ ¼</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial9-models/#ä½¿ç”¨æ­£ç¡®çº¹ç†" class="sidebar-link">ä½¿ç”¨æ­£ç¡®çº¹ç†</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial9-models/#æ¸²æŸ“å®Œæ•´æ¨¡å‹" class="sidebar-link">æ¸²æŸ“å®Œæ•´æ¨¡å‹</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>è¿›é˜¶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-cn/intermediate/tutorial10-lighting/" class="sidebar-link">ğŸš§ å¤„ç†å…‰ç…§æ•ˆæœ</a></li><li><a href="/learn-wgpu-cn/intermediate/tutorial11-normals/" class="sidebar-link">ğŸš§ æ³•çº¿è´´å›¾</a></li><li><a href="/learn-wgpu-cn/intermediate/tutorial12-camera/" class="sidebar-link">ğŸš§ æ›´å¥½çš„ç›¸æœº</a></li><li><a href="/learn-wgpu-cn/intermediate/tutorial13-threading/" class="sidebar-link">ğŸš§ åŸºäº Wgpu å’Œ Rayon çš„å¤šçº¿ç¨‹</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ¡ˆä¾‹å±•ç¤º</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ›´æ–°åŠ¨æ€</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="åŠ è½½æ¨¡å‹"><a href="#åŠ è½½æ¨¡å‹" class="header-anchor">#</a> åŠ è½½æ¨¡å‹</h1> <p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸€ç›´åœ¨æ‰‹åŠ¨åˆ›å»ºæ¨¡å‹ã€‚è™½ç„¶è¿™ä¹Ÿå¯è¡Œï¼Œä½†å¦‚æœæƒ³å¤„ç†æœ‰å¤§é‡å¤šè¾¹å½¢çš„å¤æ‚æ¨¡å‹ï¼Œè¿™æ ·åšçš„æ•ˆç‡ä¼šéå¸¸ä½ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä»£ç æ¥æ”¯æŒ obj æ¨¡å‹æ ¼å¼ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨è¯¸å¦‚ blender è¿™æ ·çš„è½¯ä»¶ä¸­åˆ›å»ºæ¨¡å‹ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸­æ˜¾ç¤ºäº†ã€‚</p> <p>ç”±äºç°åœ¨çš„ <code>main.rs</code> æ–‡ä»¶å·²ç»æœ‰äº›æ‚ä¹±ï¼Œæˆ‘ä»¬å¯ä»¥å†åˆ›å»ºä¸€ä¸ª <code>model.rs</code> æ–‡ä»¶ï¼Œåœ¨æ­¤æ”¾ç½®ç”¨äºåŠ è½½æ¨¡å‹çš„ä»£ç ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// model.rs</span>
<span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">Vertex</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">desc</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone, Debug, bytemuck::Pod, bytemuck::Zeroable)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ModelVertex</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    normal<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Vertex</span> <span class="token keyword">for</span> <span class="token class-name">ModelVertex</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">desc</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥æ³¨æ„åˆ°è¿™é‡Œæœ‰å‡ ä¸ªé‡ç‚¹ã€‚é¦–å…ˆåœ¨ <code>main.rs</code> ä¸­æˆ‘ä»¬å°† <code>Vertex</code> å»ºæ¨¡æˆäº†ä¸€ä¸ª structï¼Œè€Œè¿™é‡Œä½¿ç”¨çš„åˆ™æ˜¯ä¸€ä¸ª traitï¼Œä»¥ä¾¿æ”¯æŒå¤šç§é¡¶ç‚¹ç±»å‹ï¼ˆå¦‚æ¨¡å‹ã€ç”¨æˆ·ç•Œé¢ã€å®ä¾‹æ•°æ®ç­‰ï¼‰ã€‚å°† <code>Vertex</code> å»ºæ¨¡ä¸º trait ä¹Ÿä½¿æˆ‘ä»¬èƒ½æŠ½ç¦»å‡º <code>VertexBufferLayout</code> åˆ›å»ºéƒ¨åˆ†çš„ä»£ç ï¼Œä»è€Œç®€åŒ– <code>RenderPipeline</code> çš„åˆ›å»ºã€‚</p> <p>å¦ä¸€ä¸ªé‡ç‚¹æ˜¯ <code>ModelVertex</code> ä¸­çš„ <code>normal</code> å­—æ®µã€‚åœ¨è®¨è®ºå…‰ç…§é—®é¢˜å‰æˆ‘ä»¬è¿˜ä¸ä¼šä½¿ç”¨è¿™ä¸ªå­—æ®µï¼Œä½†ç°åœ¨æˆ‘ä»¬ä¼šå…ˆæŠŠå®ƒæ·»åŠ åˆ° struct ä¸­ã€‚</p> <p>ä¸‹é¢è®©æˆ‘ä»¬æ¥å®šä¹‰ <code>VertexBufferLayout</code>ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Vertex</span> <span class="token keyword">for</span> <span class="token class-name">ModelVertex</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">desc</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>mem<span class="token punctuation">;</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span> <span class="token punctuation">{</span>
            array_stride<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">ModelVertex</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
            step_mode<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexStepMode</span><span class="token punctuation">::</span><span class="token class-name">Vertex</span><span class="token punctuation">,</span>
            attributes<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x3</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x2</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x3</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™éƒ¨åˆ†ä»£ç åŸºæœ¬ä¸Šä¸åŸæ¥çš„ <code>VertexBufferLayout</code> ç›¸åŒï¼Œä½†æˆ‘ä»¬ä¸º <code>normal</code> å¢åŠ äº†ä¸€ä¸ª <code>VertexAttribute</code>ã€‚å¦å¤–ä¹Ÿå¯ä»¥åˆ é™¤ <code>main.rs</code> ä¸­çš„ <code>Vertex</code> structï¼Œå› ä¸ºå®ƒä¹Ÿå·²ç»ç”¨ä¸åˆ°äº†ã€‚åœ¨ <code>RenderPipeline</code> ä¸­ï¼Œä¹Ÿåº”å½“ä½¿ç”¨ä»æ¨¡å‹ä¸­æ‰€è·å¾—çš„æ–° <code>Vertex</code>ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> render_pipeline <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineDescriptor</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    vertex<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexState</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        buffers<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token namespace">model<span class="token punctuation">::</span></span><span class="token class-name">ModelVertex</span><span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">InstanceRaw</span><span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ç”±äº <code>desc</code> æ–¹æ³•æ˜¯åœ¨ <code>Vertex</code> trait ä¸Šå®ç°çš„ï¼Œå› æ­¤åœ¨è®¿é—®è¯¥æ–¹æ³•å‰éœ€å¯¼å…¥è¯¥ traitã€‚ä¸ºæ­¤åªéœ€å°†å¯¼å…¥çš„å†…å®¹æ”¾åœ¨ä»£ç æ–‡ä»¶é¡¶éƒ¨å³å¯ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">model<span class="token punctuation">::</span></span><span class="token class-name">Vertex</span><span class="token punctuation">;</span>
</code></pre></div><p>åœ¨æ­¤ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç”¨äºæ¸²æŸ“çš„æ¨¡å‹ã€‚å¦‚æœä½ æ‰‹å¤´å·²ç»æœ‰äº†æ¨¡å‹é‚£è‡ªç„¶å¾ˆå¥½ã€‚å¦‚æœè¿˜æ²¡æœ‰ï¼Œè¿™é‡Œä¹Ÿæä¾›äº†ä¸€ä¸ªå¸¦æœ‰æ¨¡å‹åŠå…¶ä¸­æ‰€æœ‰çº¹ç†çš„ <a href="https://github.com/sotrh/learn-wgpu/blob/master/code/beginner/tutorial9-models/res/cube.zip" target="_blank" rel="noopener noreferrer">zip æ–‡ä»¶<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚æˆ‘ä»¬å°†è¿™ä¸ªæ¨¡å‹æ”¾åœ¨ä¸ç°æœ‰ <code>src</code> ç›®å½•ç›¸é‚»çš„ä¸€ä¸ªæ–° <code>res</code> ç›®å½•ä¸­ã€‚</p> <h2 id="ä»èµ„æºç›®å½•ä¸­è·å–æ–‡ä»¶"><a href="#ä»èµ„æºç›®å½•ä¸­è·å–æ–‡ä»¶" class="header-anchor">#</a> ä»èµ„æºç›®å½•ä¸­è·å–æ–‡ä»¶</h2> <p>å½“ cargo æ„å»ºå¹¶è¿è¡Œç¨‹åºæ—¶ï¼Œå®ƒä¼šè®¾ç½®ä¸€ä¸ªå½“å‰å·¥ä½œç›®å½•ã€‚è¿™ä¸ªç›®å½•é€šå¸¸æ˜¯æ”¾ç½®äº†é¡¹ç›®æ ¹ç›®å½•ä¸‹ <code>Cargo.toml</code> çš„ç›®å½•ã€‚æˆ‘ä»¬èµ„æºç›®å½•æ‰€åœ¨çš„è·¯å¾„ä¹Ÿå¯èƒ½æœ‰æ‰€ä¸åŒï¼Œè¿™å–å†³äºé¡¹ç›®çš„ç»“æ„ã€‚æœ¬èŠ‚æ•™ç¨‹ç¤ºä¾‹ä»£ç çš„ <code>res</code> ç›®å½•ä½äº <code>code/beginner/tutorial9-models/res/</code>ã€‚å½“åŠ è½½æ¨¡å‹æ—¶å¯ä»¥ä½¿ç”¨è¿™ä¸ªè·¯å¾„ï¼Œåªéœ€é™„åŠ ä¸Š <code>cube.obj</code> å³å¯ã€‚è¿™æ ·ç¡®å®å¯ç”¨ï¼Œä½†å¦‚æœæˆ‘ä»¬æ”¹å˜é¡¹ç›®ç›®å½•ç»“æ„ï¼Œå°±ä¼šä½¿ä»£ç ä¸å¯ç”¨ã€‚</p> <p>æˆ‘ä»¬å°†é€šè¿‡ä¿®æ”¹æ„å»ºè„šæœ¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åªéœ€å°† <code>res</code> ç›®å½•å¤åˆ¶åˆ° cargo åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶çš„ä½ç½®ï¼Œç„¶åå†ä»é‚£é‡Œå¼•ç”¨èµ„æºå³å¯ã€‚ä¸ºæ­¤å¯ä»¥åˆ›å»ºä¸€ä¸ªåä¸º <code>build.rs</code> çš„æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">fs_extra<span class="token punctuation">::</span></span>copy_items<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">fs_extra<span class="token punctuation">::</span>dir<span class="token punctuation">::</span></span><span class="token class-name">CopyOptions</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>env<span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// è¿™é‡Œå‘Šè¯‰ cargo å¦‚æœ /res/ ç›®å½•ä¸­çš„ä»»ä½•å†…å®¹å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±é‡æ–°è¿è¡Œè„šæœ¬</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;cargo:rerun-if-changed=res/*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> out_dir <span class="token operator">=</span> <span class="token namespace">env<span class="token punctuation">::</span></span><span class="token function">var</span><span class="token punctuation">(</span><span class="token string">&quot;OUT_DIR&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> copy_options <span class="token operator">=</span> <span class="token class-name">CopyOptions</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    copy_options<span class="token punctuation">.</span>overwrite <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> paths_to_copy <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    paths_to_copy<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;res/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">copy_items</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>paths_to_copy<span class="token punctuation">,</span> out_dir<span class="token punctuation">,</span> <span class="token operator">&amp;</span>copy_options<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="note"><p>è¯·ç¡®ä¿å°† <code>build.rs</code> æ”¾åœ¨ä¸ <code>Cargo.toml</code> ç›¸åŒçš„ç›®å½•ä¸­ã€‚å¦åˆ™åœ¨ crate æ„å»ºæ—¶ cargo ä¸ä¼šè¿è¡Œæ„å»ºè„šæœ¬ã€‚</p></div> <div class="note"><p><code>OUT_DIR</code> æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œcargo ç”¨å®ƒæ¥æŒ‡å®šåº”ç”¨æ„å»ºäº§ç‰©çš„è¾“å‡ºä½ç½®ã€‚</p></div> <p>å¦å¤–è¿˜è¦ä¿®æ”¹ <code>Cargo.toml</code> æ¥è®©ä¸Šè¿°æ”¹åŠ¨èƒ½æ­£å¸¸å·¥ä½œã€‚ä¸ºæ­¤éœ€åœ¨ <code>[dependencies]</code> ä½ç½®æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">build-dependencies</span><span class="token punctuation">]</span>
<span class="token key property">anyhow</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.0&quot;</span>
<span class="token key property">fs_extra</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.2&quot;</span>
<span class="token key property">glob</span> <span class="token punctuation">=</span> <span class="token string">&quot;0.3&quot;</span>
</code></pre></div><h2 id="ä½¿ç”¨-tobj-åŠ è½½æ¨¡å‹"><a href="#ä½¿ç”¨-tobj-åŠ è½½æ¨¡å‹" class="header-anchor">#</a> ä½¿ç”¨ TOBJ åŠ è½½æ¨¡å‹</h2> <p>æˆ‘ä»¬å°†ç”¨ <a href="https://docs.rs/tobj/3.0/tobj/" target="_blank" rel="noopener noreferrer">tobj<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> åº“æ¥åŠ è½½æ¨¡å‹ã€‚é¦–å…ˆå°†å…¶æ·»åŠ åˆ° <code>Cargo.toml</code> ä¸­ï¼š</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token comment"># other dependencies...</span>
<span class="token key property">tobj</span> <span class="token punctuation">=</span> <span class="token string">&quot;3.0&quot;</span>
</code></pre></div><p>ä¸è¿‡åœ¨èƒ½åŠ è½½æ¨¡å‹å‰ï¼Œæˆ‘ä»¬è¿˜éœ€è¦èƒ½åœ¨ä»£ç ä¸­æ”¾ä¸‹å®ƒï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// model.rs</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Model</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> meshes<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Mesh</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> materials<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Material</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥æ³¨æ„åˆ°æˆ‘ä»¬çš„ <code>Model</code> struct ä¸­åˆ†åˆ«æœ‰ä¸€ä¸ªç”¨äº <code>meshes</code>ï¼ˆç½‘æ ¼ï¼‰å’Œ <code>materials</code>ï¼ˆæè´¨ï¼‰çš„ <code>Vec</code>ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸º obj æ–‡ä»¶ä¸­å¯ä»¥åŒ…å«å¤šä»½ç½‘æ ¼å’Œæè´¨ã€‚ç„¶åæˆ‘ä»¬ä»ç„¶éœ€è¦åˆ›å»º <code>Mesh</code> å’Œ <code>Material</code> ç±»ï¼Œåƒè¿™æ ·ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Material</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> diffuse_texture<span class="token punctuation">:</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> bind_group<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Mesh</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> vertex_buffer<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Buffer</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> index_buffer<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Buffer</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> num_elements<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> material<span class="token punctuation">:</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>Material</code> ç›¸å½“ç®€å•ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ªåç§°å­—æ®µå’Œä¸€ä¸ªçº¹ç†å­—æ®µã€‚æˆ‘ä»¬çš„ç«‹æ–¹ä½“ obj æ–‡ä»¶ä¸­å®é™…ä¸Šæœ‰ 2 ä¸ªçº¹ç†ï¼Œä½†å…¶ä¸­ä¸€ä¸ªæ˜¯æ³•çº¿è´´å›¾ï¼Œæˆ‘ä»¬å°†åœ¨<a href="../../intermediate/tutorial11-normals">åé¢</a>å¯¹å…¶ä½œä»‹ç»ã€‚åç§°å­—æ®µæ›´å¤šæ˜¯ä¸ºäº†è°ƒè¯•è€ŒåŠ å…¥çš„ã€‚</p> <p>è¯´åˆ°çº¹ç†ï¼Œæˆ‘ä»¬éœ€è¦ä¸º <code>texture.rs</code> ä¸­çš„ <code>Texture</code> æ·»åŠ ä¸€ä¸ª <code>load()</code> æ–¹æ³•ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token class-name">Path</span><span class="token punctuation">;</span>

<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">load</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token class-name">Path</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>
    device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
    queue<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Queue</span><span class="token punctuation">,</span>
    path<span class="token punctuation">:</span> <span class="token class-name">P</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// éœ€è¦è¿™æ ·å¤„ç†æ¥æ»¡è¶³ borrow checker</span>
    <span class="token keyword">let</span> path_copy <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to_path_buf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> label <span class="token operator">=</span> path_copy<span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">let</span> img <span class="token operator">=</span> <span class="token namespace">image<span class="token punctuation">::</span></span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">from_image</span><span class="token punctuation">(</span>device<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>img<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ä¸ºæ¨¡å‹åŠ è½½çº¹ç†æ—¶ï¼Œ<code>load</code> æ–¹æ³•ä¼šéå¸¸æœ‰ç”¨ã€‚è¿™æ˜¯å› ä¸º <code>include_bytes!</code> è¦æ±‚æˆ‘ä»¬åœ¨ç¼–è¯‘æ—¶çŸ¥é“æ–‡ä»¶åï¼Œä½†æˆ‘ä»¬å¯¹æ¨¡å‹çº¹ç†å¹¶ä¸èƒ½çœŸæ­£ä¿è¯è¿™ä¸€ç‚¹ã€‚</p> <p>æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ <code>model.rs</code> ä¸­å¯¼å…¥ <code>texture.rs</code>ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>texture</span><span class="token punctuation">;</span>
</code></pre></div><p>æˆ‘ä»¬è¿˜éœ€è¦å¯¹ <code>texture.rs</code> ä¸­çš„ <code>from_image()</code> æ–¹æ³•åšä¸€ç‚¹ç»†å¾®çš„æ”¹åŠ¨ã€‚ç”±äº PNG å›¾åƒæœ‰ alpha é€šé“ï¼Œå®ƒä»¬åœ¨ <code>as_rgba8()</code> æ—¶è¿è¡Œè‰¯å¥½ã€‚ä½† JPEG å›¾åƒæ²¡æœ‰ alpha é€šé“ï¼Œå¦‚æœæˆ‘ä»¬è¯•å›¾åœ¨è¦ä½¿ç”¨çš„ JPEG çº¹ç†å›¾åƒä¸Šè°ƒç”¨ <code>as_rgba8()</code>ï¼Œä»£ç å°±ä¼šå‡ºé—®é¢˜ã€‚ä¸è¿‡ç›¸ååœ°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>to_rgba8()</code> æ¥å¤„ç†è¿™æ ·çš„å›¾åƒã€‚è¿™æ ·å³ä½¿åŸå§‹å›¾åƒæ²¡æœ‰ alpha é€šé“ï¼Œè¿™ä¸ª API ä¹Ÿä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å›¾åƒç¼“å†²åŒºï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> rgba <span class="token operator">=</span> img<span class="token punctuation">.</span><span class="token function">to_rgba8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>ç”±äº <code>rgba</code> ç°åœ¨æ˜¯ä¸€ä¸ªæ–°çš„å›¾åƒç¼“å†²åŒºï¼Œè€Œä¸æ˜¯å¯¹åŸå§‹å›¾åƒç¼“å†²åŒºçš„å¼•ç”¨ï¼Œå› æ­¤å½“åé¢è°ƒç”¨ <code>write_texture</code> æ—¶ï¼Œéœ€è¦ä»¥å¼•ç”¨å½¢å¼æ¥ä¼ é€’å®ƒï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code>    <span class="token comment">//...</span>
    <span class="token operator">&amp;</span>rgba<span class="token punctuation">,</span>  <span class="token comment">// UPDATED!</span>
    <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ImageDataLayout</span> <span class="token punctuation">{</span>
</code></pre></div><p><code>Mesh</code> ä¸­æŒæœ‰ä¸€ä¸ªé¡¶ç‚¹ç¼“å†²åŒºã€ä¸€ä¸ªç´¢å¼•ç¼“å†²åŒºï¼Œä»¥åŠç½‘æ ¼ä¸­çš„ç´¢å¼•æ•°ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ª <code>usize</code> æ¥è¡¨ç¤ºæè´¨ï¼Œè¿™ä¸ª <code>usize</code> å°†åœ¨ç»˜åˆ¶æ—¶ç”¨äºç´¢å¼• <code>materials</code> åˆ—è¡¨ï¼š</p> <p>å®Œæˆè¿™äº›ä¹‹åï¼Œå°±å¯ä»¥å¼€å§‹åŠ è½½æ¨¡å‹äº†ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">load</span><span class="token operator">&lt;</span><span class="token class-name">P</span><span class="token punctuation">:</span> <span class="token class-name">AsRef</span><span class="token operator">&lt;</span><span class="token class-name">Path</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>
        device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
        queue<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Queue</span><span class="token punctuation">,</span>
        layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayout</span><span class="token punctuation">,</span>
        path<span class="token punctuation">:</span> <span class="token class-name">P</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>obj_models<span class="token punctuation">,</span> obj_materials<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token namespace">tobj<span class="token punctuation">::</span></span><span class="token function">load_obj</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token class-name">LoadOptions</span> <span class="token punctuation">{</span>
                triangulate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                single_index<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> obj_materials <span class="token operator">=</span> obj_materials<span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token comment">// æˆ‘ä»¬å‡è®¾çº¹ç†æ–‡ä»¶æ˜¯å’Œ obj æ–‡ä»¶ä¸€èµ·å­˜å‚¨çš„</span>
        <span class="token keyword">let</span> containing_folder <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span><span class="token string">&quot;Directory has no parent&quot;</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> materials <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> mat <span class="token keyword">in</span> obj_materials <span class="token punctuation">{</span>
            <span class="token keyword">let</span> diffuse_path <span class="token operator">=</span> mat<span class="token punctuation">.</span>diffuse_texture<span class="token punctuation">;</span>
            <span class="token keyword">let</span> diffuse_texture <span class="token operator">=</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span>device<span class="token punctuation">,</span> queue<span class="token punctuation">,</span> containing_folder<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>diffuse_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

            <span class="token keyword">let</span> bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupDescriptor</span> <span class="token punctuation">{</span>
                layout<span class="token punctuation">,</span>
                entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                    <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                        binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                        resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>diffuse_texture<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                        binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                        resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>diffuse_texture<span class="token punctuation">.</span>sampler<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
                label<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            materials<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Material</span> <span class="token punctuation">{</span>
                name<span class="token punctuation">:</span> mat<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                diffuse_texture<span class="token punctuation">,</span>
                bind_group<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> meshes <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> m <span class="token keyword">in</span> obj_models <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> vertices <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token punctuation">..</span>m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>positions<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span> <span class="token punctuation">{</span>
                vertices<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">ModelVertex</span> <span class="token punctuation">{</span>
                    position<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>positions<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>positions<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>positions<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                    tex_coords<span class="token punctuation">:</span> <span class="token punctuation">[</span>m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>texcoords<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>texcoords<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    normal<span class="token punctuation">:</span> <span class="token punctuation">[</span>
                        m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>normals<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>normals<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                        m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>normals<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">let</span> vertex_buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer_init</span><span class="token punctuation">(</span>
                <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span>util<span class="token punctuation">::</span></span><span class="token class-name">BufferInitDescriptor</span> <span class="token punctuation">{</span>
                    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?} Vertex Buffer&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    contents<span class="token punctuation">:</span> <span class="token namespace">bytemuck<span class="token punctuation">::</span></span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vertices<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferUsages</span><span class="token punctuation">::</span><span class="token constant">VERTEX</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> index_buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer_init</span><span class="token punctuation">(</span>
                <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span>util<span class="token punctuation">::</span></span><span class="token class-name">BufferInitDescriptor</span> <span class="token punctuation">{</span>
                    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token macro property">format!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?} Index Buffer&quot;</span><span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">as_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    contents<span class="token punctuation">:</span> <span class="token namespace">bytemuck<span class="token punctuation">::</span></span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>indices<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferUsages</span><span class="token punctuation">::</span><span class="token constant">INDEX</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>

            meshes<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token class-name">Mesh</span> <span class="token punctuation">{</span>
                name<span class="token punctuation">:</span> m<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                vertex_buffer<span class="token punctuation">,</span>
                index_buffer<span class="token punctuation">,</span>
                num_elements<span class="token punctuation">:</span> m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>indices<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
                material<span class="token punctuation">:</span> m<span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>material_id<span class="token punctuation">.</span><span class="token function">unwrap_or</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">Self</span> <span class="token punctuation">{</span> meshes<span class="token punctuation">,</span> materials <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="æ¸²æŸ“ç½‘æ ¼"><a href="#æ¸²æŸ“ç½‘æ ¼" class="header-anchor">#</a> æ¸²æŸ“ç½‘æ ¼</h2> <p>åœ¨èƒ½å¤Ÿç»˜åˆ¶æ¨¡å‹å‰ï¼Œæˆ‘ä»¬éœ€è¦èƒ½ç»˜åˆ¶ä¸€ä»½ç‹¬ç«‹çš„ç½‘æ ¼ã€‚ä¸ºæ­¤å¯åˆ›å»ºä¸€ä¸ªåä¸º <code>DrawModel</code> çš„ traitï¼Œå¹¶ä¸º <code>RenderPass</code> å®ç°å®ƒï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">DrawModel</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">draw_mesh</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> mesh<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Mesh</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">draw_mesh_instanced</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        mesh<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Mesh</span><span class="token punctuation">,</span>
        instances<span class="token punctuation">:</span> <span class="token class-name">Range</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">'b</span><span class="token operator">&gt;</span> <span class="token class-name">DrawModel</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'b</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPass</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token lifetime-annotation symbol">'b</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">draw_mesh</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> mesh<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token class-name">Mesh</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">draw_mesh_instanced</span><span class="token punctuation">(</span>mesh<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">draw_mesh_instanced</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        mesh<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token class-name">Mesh</span><span class="token punctuation">,</span>
        instances<span class="token punctuation">:</span> <span class="token class-name">Range</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> mesh<span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">set_index_buffer</span><span class="token punctuation">(</span>mesh<span class="token punctuation">.</span>index_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">IndexFormat</span><span class="token punctuation">::</span><span class="token class-name">Uint32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>mesh<span class="token punctuation">.</span>num_elements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> instances<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠè¿™äº›æ–¹æ³•æ”¾åœ¨ <code>impl Model</code> ä¸­ï¼Œä½†ç¬”è€…è®¤ä¸ºè®© <code>RenderPass</code> åšæ‰€æœ‰çš„æ¸²æŸ“æ›´åŠ åˆç†ï¼Œå› ä¸ºè¿™å°±æ˜¯å®ƒçš„èŒè´£ã€‚è¿™æ ·å°±æ„å‘³ç€æˆ‘ä»¬åœ¨æ¸²æŸ“æ—¶å¿…é¡»å¯¼å…¥ <code>DrawModel</code>ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// main.rs</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>instance_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>diffuse_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>camera_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">model<span class="token punctuation">::</span></span><span class="token class-name">DrawModel</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">draw_mesh_instanced</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>obj_model<span class="token punctuation">.</span>meshes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>instances<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä½†åœ¨æ­¤ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å®é™…åŠ è½½æ¨¡å‹å¹¶å°†å…¶ä¿å­˜åˆ° <code>State</code>ã€‚ä¸ºæ­¤å¯åœ¨ <code>State::new()</code> ä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> res_dir <span class="token operator">=</span> <span class="token namespace">std<span class="token punctuation">::</span>path<span class="token punctuation">::</span></span><span class="token class-name">Path</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token macro property">env!</span><span class="token punctuation">(</span><span class="token string">&quot;OUT_DIR&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;res&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> obj_model <span class="token operator">=</span> <span class="token namespace">model<span class="token punctuation">::</span></span><span class="token class-name">Model</span><span class="token punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span>device<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>queue<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>texture_bind_group_layout<span class="token punctuation">,</span>
    res_dir<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;cube.obj&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="note"><p>è¿™é‡Œæˆ‘ä»¬ç”¨ <code>OUT_DIR</code> æ¥è·å– <code>res</code> ç›®å½•è·¯å¾„ã€‚</p></div> <p>æˆ‘ä»¬çš„æ–°æ¨¡å‹æ¯”ä¹‹å‰çš„æ¨¡å‹è¿˜è¦å¤§ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è°ƒæ•´ä¸€ä¸‹å®ä¾‹ä¹‹é—´çš„é—´è·ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">const</span> <span class="token constant">SPACE_BETWEEN</span><span class="token punctuation">:</span> <span class="token keyword">f32</span> <span class="token operator">=</span> <span class="token number">3.0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> instances <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>z<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token constant">SPACE_BETWEEN</span> <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">-</span> <span class="token constant">NUM_INSTANCES_PER_ROW</span> <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> z <span class="token operator">=</span> <span class="token constant">SPACE_BETWEEN</span> <span class="token operator">*</span> <span class="token punctuation">(</span>z <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">-</span> <span class="token constant">NUM_INSTANCES_PER_ROW</span> <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> position <span class="token operator">=</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span> <span class="token punctuation">{</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> z <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> rotation <span class="token operator">=</span> <span class="token keyword">if</span> position<span class="token punctuation">.</span><span class="token function">is_zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span><span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token punctuation">::</span><span class="token function">unit_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Deg</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Deg</span><span class="token punctuation">(</span><span class="token number">45.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token class-name">Instance</span> <span class="token punctuation">{</span>
            position<span class="token punctuation">,</span> rotation<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>å®Œæˆååº”è¯¥è·å¾—è¿™æ ·çš„æ•ˆæœï¼š</p> <p><img src="/learn-wgpu-cn/assets/img/cubes.988d14be.png" alt="cubes.png"></p> <h2 id="ä½¿ç”¨æ­£ç¡®çº¹ç†"><a href="#ä½¿ç”¨æ­£ç¡®çº¹ç†" class="header-anchor">#</a> ä½¿ç”¨æ­£ç¡®çº¹ç†</h2> <p>å¦‚æœä½ æ£€æŸ¥ä¸€ä¸‹ obj å¯¹åº”çš„çº¹ç†æ–‡ä»¶ï¼Œä½ ä¼šå‘ç°å®ƒä»¬ä¸åŸå§‹ obj æ–‡ä»¶å¹¶ä¸åŒ¹é…ã€‚æˆ‘ä»¬æƒ³çœ‹åˆ°çš„çº¹ç†æ˜¯è¿™æ ·çš„ï¼š</p> <p><img src="/learn-wgpu-cn/assets/img/cube-diffuse.03fc55af.jpg" alt="cube-diffuse.jpg"></p> <p>ä½†æˆ‘ä»¬å¾—åˆ°çš„ä»ç„¶æ˜¯å¿«ä¹å°æ ‘çš„çº¹ç†ã€‚</p> <p>è¿™ä¸ªé—®é¢˜çš„åŸå› å¾ˆç®€å•ï¼Œæ˜¯å› ä¸ºå°½ç®¡æˆ‘ä»¬å·²ç»åˆ›å»ºäº†çº¹ç†ï¼Œä½†è¿˜æ²¡æœ‰åˆ›å»ºä¸€ä¸ª bind group ç»™åˆ° <code>RenderPass</code>ã€‚æˆ‘ä»¬ä»ç„¶åœ¨ä½¿ç”¨æ—§çš„ <code>diffuse_bind_group</code>ã€‚å¦‚æœæƒ³æ”¹å˜è¿™ä¸€ç‚¹ï¼Œå°±è¦ä½¿ç”¨æˆ‘ä»¬æè´¨çš„ bind groupï¼Œå³ <code>Material</code> struct ä¸‹çš„ <code>bind_group</code> æˆå‘˜ã€‚</p> <p>æˆ‘ä»¬å…ˆè¦ç»™ <code>DrawModel</code> æ·»åŠ ä¸€ä¸ªæè´¨å‚æ•°ã€‚</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">DrawModel</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">draw_mesh</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> mesh<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Mesh</span><span class="token punctuation">,</span> material<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Material</span><span class="token punctuation">,</span> camera_bind_group<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">draw_mesh_instanced</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        mesh<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Mesh</span><span class="token punctuation">,</span>
        material<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Material</span><span class="token punctuation">,</span>
        instances<span class="token punctuation">:</span> <span class="token class-name">Range</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        camera_bind_group<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">'b</span><span class="token operator">&gt;</span> <span class="token class-name">DrawModel</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'b</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPass</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token lifetime-annotation symbol">'b</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">draw_mesh</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> mesh<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token class-name">Mesh</span><span class="token punctuation">,</span> material<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token class-name">Material</span><span class="token punctuation">,</span> camera_bind_group<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">draw_mesh_instanced</span><span class="token punctuation">(</span>mesh<span class="token punctuation">,</span> material<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">,</span> camera_bind_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">draw_mesh_instanced</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        mesh<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token class-name">Mesh</span><span class="token punctuation">,</span>
        material<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token class-name">Material</span><span class="token punctuation">,</span>
        instances<span class="token punctuation">:</span> <span class="token class-name">Range</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        camera_bind_group<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> mesh<span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">set_index_buffer</span><span class="token punctuation">(</span>mesh<span class="token punctuation">.</span>index_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">IndexFormat</span><span class="token punctuation">::</span><span class="token class-name">Uint32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>material<span class="token punctuation">.</span>bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> camera_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span>mesh<span class="token punctuation">.</span>num_elements<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> instances<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç„¶åè¿˜éœ€è¦ä¿®æ”¹æ¸²æŸ“ä»£ç ä»¥ä½¿å…¶ç”Ÿæ•ˆï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code>render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>instance_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> mesh <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>obj_model<span class="token punctuation">.</span>meshes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> material <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>obj_model<span class="token punctuation">.</span>materials<span class="token punctuation">[</span>mesh<span class="token punctuation">.</span>material<span class="token punctuation">]</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">draw_mesh_instanced</span><span class="token punctuation">(</span>mesh<span class="token punctuation">,</span> material<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>instances<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>camera_bind_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬åº”è¯¥èƒ½è·å¾—ä»¥ä¸‹æ•ˆæœï¼š</p> <p><img src="/learn-wgpu-cn/assets/img/cubes-correct.2db711eb.png" alt="cubes-correct.png"></p> <h2 id="æ¸²æŸ“å®Œæ•´æ¨¡å‹"><a href="#æ¸²æŸ“å®Œæ•´æ¨¡å‹" class="header-anchor">#</a> æ¸²æŸ“å®Œæ•´æ¨¡å‹</h2> <p>ç°åœ¨æˆ‘ä»¬ç›´æ¥æŒ‡å®šå¥½äº†ç½‘æ ¼å’Œæè´¨ï¼Œè¿™åœ¨æƒ³ç”¨ä¸åŒçš„æè´¨æ¥ç»˜åˆ¶ç½‘æ ¼æ—¶ä¼šå¾ˆæœ‰ç”¨ã€‚å¦å¤–å¦‚æœæ¨¡å‹ç”±å¤šä¸ªéƒ¨åˆ†ç»„æˆï¼Œæˆ‘ä»¬è¿˜ä¸èƒ½æ¸²æŸ“å‡ºæ¨¡å‹çš„å…¶ä»–éƒ¨åˆ†ã€‚ä¸ºæ­¤å¯åœ¨ <code>DrawModel</code> ä¸Šåˆ›å»ºä¸€ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­å¯æŒ‰æ¨¡å‹ä¸­å„éƒ¨åˆ†çš„æè´¨æ¥å¯¹å…¶åšç»˜åˆ¶ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">DrawModel</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">draw_model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> model<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Model</span><span class="token punctuation">,</span> camera_bind_group<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">draw_model_instanced</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        model<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Model</span><span class="token punctuation">,</span>
        instances<span class="token punctuation">:</span> <span class="token class-name">Range</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        camera_bind_group<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">'b</span><span class="token operator">&gt;</span> <span class="token class-name">DrawModel</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'b</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPass</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span>
<span class="token keyword">where</span>
    <span class="token lifetime-annotation symbol">'b</span><span class="token punctuation">:</span> <span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">draw_model</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> model<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token class-name">Model</span><span class="token punctuation">,</span> camera_bind_group<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">draw_model_instanced</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">,</span> camera_bind_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">draw_model_instanced</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
        model<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token class-name">Model</span><span class="token punctuation">,</span>
        instances<span class="token punctuation">:</span> <span class="token class-name">Range</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        camera_bind_group<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> mesh <span class="token keyword">in</span> <span class="token operator">&amp;</span>model<span class="token punctuation">.</span>meshes <span class="token punctuation">{</span>
            <span class="token keyword">let</span> material <span class="token operator">=</span> <span class="token operator">&amp;</span>model<span class="token punctuation">.</span>materials<span class="token punctuation">[</span>mesh<span class="token punctuation">.</span>material<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">draw_mesh_instanced</span><span class="token punctuation">(</span>mesh<span class="token punctuation">,</span> material<span class="token punctuation">,</span> instances<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> camera_bind_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>main.rs</code> ä¸­ä»£ç ä¹Ÿéœ€è¦ç›¸åº”çš„æ”¹å˜ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code>render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>instance_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">draw_model_instanced</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>obj_model<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>instances<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>camera_bind_group<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/beginner/tutorial9-models/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/30/2022, 2:50:47 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/learn-wgpu-cn/beginner/tutorial8-depth/" class="prev">
          æ·±åº¦ç¼“å†²åŒº
        </a></span> <span class="next"><a href="/learn-wgpu-cn/intermediate/tutorial10-lighting/">
          ğŸš§ å¤„ç†å…‰ç…§æ•ˆæœ
        </a>
        â†’
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu-cn/assets/js/app.4a62b3f5.js" defer></script><script src="/learn-wgpu-cn/assets/js/4.9ddd2a75.js" defer></script><script src="/learn-wgpu-cn/assets/js/11.1001c632.js" defer></script><script src="/learn-wgpu-cn/assets/js/25.5a7a1f31.js" defer></script>
  </body>
</html>
