<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 Surface | 学习 Wgpu</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    <meta property="article:modified_time" content="2022-04-24T02:02:09.000Z">
    <meta property="og:site_name" content="学习 Wgpu">
    <meta property="og:title" content="使用 Surface">
    <meta property="og:type" content="website">
    <meta property="og:url" content="/beginner/tutorial2-surface/">
    <meta name="twitter:title" content="使用 Surface">
    <meta name="twitter:url" content="/beginner/tutorial2-surface/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Benjamin Hansen">
    <meta name="twitter:creator" content="https://twitter.com/sotrh760">
    
    <link rel="preload" href="/learn-wgpu-cn/assets/css/0.styles.9735b80e.css" as="style"><link rel="preload" href="/learn-wgpu-cn/assets/js/app.4ff5359b.js" as="script"><link rel="preload" href="/learn-wgpu-cn/assets/js/4.7de995c5.js" as="script"><link rel="preload" href="/learn-wgpu-cn/assets/js/14.27582479.js" as="script"><link rel="preload" href="/learn-wgpu-cn/assets/js/25.997fcfd2.js" as="script"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/1.5a74b06a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/10.7328fa8a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/11.7ede3084.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/12.1618c781.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/13.8ed4ca2f.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/15.866ab171.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/16.65e20a6a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/17.13dd0d98.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/18.0b7e17b3.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/19.e99c2c0b.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/2.1ff473f9.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/20.e60a9b69.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/21.640f3b7f.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/22.5e9abdb4.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/23.428ad388.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/24.ddf53bad.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/26.d0cb4a73.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/27.4b3c16d0.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/28.e072a203.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/29.126bb05e.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/30.661cb844.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/31.4d3f435a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/32.e5012b0b.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/33.336b62e7.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/34.08650f25.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/35.20773e94.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/5.79560850.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/6.4f6de209.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/7.430483e0.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/8.24d6fd2e.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/9.0426af3e.js">
    <link rel="stylesheet" href="/learn-wgpu-cn/assets/css/0.styles.9735b80e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu-cn/" class="home-link router-link-active"><!----> <span class="site-name">学习 Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu-cn/" aria-current="page" class="sidebar-link">介绍</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>入门</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-cn/beginner/tutorial1-window/" class="sidebar-link">依赖与窗口</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial2-surface/" aria-current="page" class="active sidebar-link">使用 Surface</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial2-surface/#先做些整理-建模-state" class="sidebar-link">先做些整理：建模 State</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial2-surface/#state-new" class="sidebar-link">State::new()</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial2-surface/#resize" class="sidebar-link">resize()</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial2-surface/#input" class="sidebar-link">input()</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial2-surface/#update" class="sidebar-link">update()</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial2-surface/#render" class="sidebar-link">render()</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial2-surface/#关于-renderpassdescriptor" class="sidebar-link">关于 RenderPassDescriptor</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial2-surface/#关于-validation-error" class="sidebar-link">关于 Validation Error</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial2-surface/#小测验" class="sidebar-link">小测验</a></li></ul></li><li><a href="/learn-wgpu-cn/beginner/tutorial3-pipeline/" class="sidebar-link">使用 Pipeline</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial4-buffer/" class="sidebar-link">顶点缓冲区与索引缓冲区</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial5-textures/" class="sidebar-link">纹理与 BindGroup</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial6-uniforms/" class="sidebar-link">Uniform 缓冲区与 3D 相机</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial7-instancing/" class="sidebar-link">实例化绘制</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial8-depth/" class="sidebar-link">深度缓冲区</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial9-models/" class="sidebar-link">加载模型</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-cn/intermediate/tutorial10-lighting/" class="sidebar-link">🚧 处理光照效果</a></li><li><a href="/learn-wgpu-cn/intermediate/tutorial11-normals/" class="sidebar-link">🚧 法线贴图</a></li><li><a href="/learn-wgpu-cn/intermediate/tutorial12-camera/" class="sidebar-link">🚧 更好的相机</a></li><li><a href="/learn-wgpu-cn/intermediate/tutorial13-threading/" class="sidebar-link">🚧 基于 Wgpu 和 Rayon 的多线程</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>案例展示</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>更新动态</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="使用-surface"><a href="#使用-surface" class="header-anchor">#</a> 使用 Surface</h1> <h2 id="先做些整理-建模-state"><a href="#先做些整理-建模-state" class="header-anchor">#</a> 先做些整理：建模 State</h2> <p>为方便起见，我们将把所有的字段打包在一个 struct 内，并在其上添加一些方法：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// main.rs</span>
<span class="token keyword">use</span> <span class="token namespace">winit<span class="token punctuation">::</span>window<span class="token punctuation">::</span></span><span class="token class-name">Window</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    surface<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Surface</span><span class="token punctuation">,</span>
    device<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
    queue<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Queue</span><span class="token punctuation">,</span>
    config<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceConfiguration</span><span class="token punctuation">,</span>
    size<span class="token punctuation">:</span> <span class="token namespace">winit<span class="token punctuation">::</span>dpi<span class="token punctuation">::</span></span><span class="token class-name">PhysicalSize</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token comment">// 某些 wgpu 类型需要使用异步代码才能创建</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Window</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">resize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> new_size<span class="token punctuation">:</span> <span class="token namespace">winit<span class="token punctuation">::</span>dpi<span class="token punctuation">::</span></span><span class="token class-name">PhysicalSize</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">WindowEvent</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">update</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">render</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token macro property">todo!</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此处会概述性介绍 <code>State</code> 下的字段。当后续章节中解释这些方法背后的代码时，它们的拆分会显得更加合理。</p> <h2 id="state-new"><a href="#state-new" class="header-anchor">#</a> State::new()</h2> <p>这部分代码非常直接，但我们可以对它进行一些拆解：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Window</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> size <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">inner_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// instance 变量是到 GPU 的 handle</span>
        <span class="token comment">// Backends::all 对应 Vulkan + Metal + DX12 + 浏览器的 WebGPU</span>
        <span class="token keyword">let</span> instance <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Instance</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Backends</span><span class="token punctuation">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> surface <span class="token operator">=</span> <span class="token keyword">unsafe</span> <span class="token punctuation">{</span> instance<span class="token punctuation">.</span><span class="token function">create_surface</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> adapter <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">request_adapter</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RequestAdapterOptions</span> <span class="token punctuation">{</span>
                power_preference<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PowerPreference</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                compatible_surface<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>surface<span class="token punctuation">)</span><span class="token punctuation">,</span>
                force_fallback_adapter<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="instance-与-adapter"><a href="#instance-与-adapter" class="header-anchor">#</a> Instance 与 Adapter</h3> <p><code>instance</code> 是使用 wgpu 时所需创建的第一个实体，其主要用途是创建 <code>Adapter</code> 和 <code>Surface</code>。</p> <p><code>adapter</code>（适配器）是指向实际显卡的一个 handle。我们可以用它获取关于显卡的信息，例如显卡名称与其所适配到的后端等。稍后我们会用它来创建 <code>Device</code> 和 <code>Queue</code>。在此之前我们需要先讨论一下 <code>RequestAdapterOptions</code> 所涉及的字段。</p> <ul><li><code>power_preference</code> 参数有两个可选项：<code>LowPower</code> 和 <code>HighPerformance</code>。选择 <code>LowPower</code> 时将对应一个有利于电池续航的适配器（如集成显卡）。相应地，<code>HighPerformance</code> 对应的适配器将指向独立显卡这样更耗电但性能更强的 GPU。如果不存在符合 <code>HighPerformance</code> 选项的适配器，wgpu 将选择 <code>LowPower</code>。</li> <li><code>compatible_surface</code> 字段要求 wgpu 所找到的适配器应当能与此处所传入的 surface 兼容。</li> <li><code>force_fallback_adapter</code> 强制 wgpu 选择一个能在所有硬件上工作的适配器。这通常表明渲染后端将使用一个「软渲染」系统，而非 GPU 这样的硬件。</li></ul> <div class="note"><p>此处我们传递给 <code>request_adapter</code> 的选项未必能对所有设备生效，但应当能在大多数设备上可用。如果 wgpu 找不到符合要求的适配器，<code>request_adapter</code> 将返回 <code>None</code>。如果你想获得某个特定后端所支持的全部适配器，可以使用 <code>enumerate_adapters</code>。它会返回一个迭代器，可以遍历检查其中是否存在符合要求 的适配器。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> adapter <span class="token operator">=</span> instance
    <span class="token punctuation">.</span><span class="token function">enumerate_adapters</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Backends</span><span class="token punctuation">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>adapter<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
        <span class="token comment">// 检查该适配器是否支持我们的 surface</span>
        surface<span class="token punctuation">.</span><span class="token function">get_preferred_format</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adapter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_some</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>还有一点值得注意：<code>Adapter</code> 是固定于某个特定后端的。如果你在 Windows 系统上有两块显卡，那么你至少就有 4 个适配器可以使用，其中两个支持 Vulkan，两个支持 DirectX。</p> <p>如果想知道更多用于改进适配器搜索过程的字段，<a href="https://docs.rs/wgpu/0.12.0/wgpu/struct.Adapter.html" target="_blank" rel="noopener noreferrer">请参见文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p></div> <h3 id="surface"><a href="#surface" class="header-anchor">#</a> Surface</h3> <p><code>surface</code> 是我们所绘制窗口的一部分，需要通过它来将内容上屏。为此我们的 <code>window</code> 需要实现 <a href="https://crates.io/crates/raw-window-handle" target="_blank" rel="noopener noreferrer">raw-window-handle<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 中的<code>HasRawWindowHandle</code> trait 来创建 surface。所幸 winit 的 <code>Window</code> 符合这个要求。另外我们还需要用 surface 来请求 <code>adapter</code>。</p> <h3 id="device-与-queue"><a href="#device-与-queue" class="header-anchor">#</a> Device 与 Queue</h3> <p>我们可以用 <code>adapter</code> 来创建 <code>device</code> 和 <code>queue</code>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>        <span class="token keyword">let</span> <span class="token punctuation">(</span>device<span class="token punctuation">,</span> queue<span class="token punctuation">)</span> <span class="token operator">=</span> adapter<span class="token punctuation">.</span><span class="token function">request_device</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">DeviceDescriptor</span> <span class="token punctuation">{</span>
                features<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Features</span><span class="token punctuation">::</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                limits<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Limits</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                label<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token class-name">None</span><span class="token punctuation">,</span> <span class="token comment">// 是否追踪 API 调用路径</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>DeviceDescriptor</code> 上的 <code>features</code> 字段允许我们指定我们想要的额外特性。对现在这个简单的例子，我们不需要用到额外的特性。</p> <div class="note"><p>你的显卡会限制你可以使用的特性。如果你想使用某些高级特性，那可能需要限制应用所支持的设备，或实现变通方案。</p> <p>你可以用 <code>adapter.features()</code> 或 <code>device.features()</code> 获得设备所支持特性的列表。可以在<a href="https://docs.rs/wgpu/0.12.0/wgpu/struct.Features.html" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>查看完整的特性列表。</p></div> <p><code>limits</code> 字段描述了对我们所能创建的某些资源类型的限制。我们将在本教程中使用默认值，这样可以支持大多数设备。可以在<a href="https://docs.rs/wgpu/0.12.0/wgpu/struct.Limits.html" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>查看详细的限制情况。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>        <span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceConfiguration</span> <span class="token punctuation">{</span>
            usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">RENDER_ATTACHMENT</span><span class="token punctuation">,</span>
            format<span class="token punctuation">:</span> surface<span class="token punctuation">.</span><span class="token function">get_preferred_format</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adapter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            width<span class="token punctuation">:</span> size<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
            height<span class="token punctuation">:</span> size<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
            present_mode<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PresentMode</span><span class="token punctuation">::</span><span class="token class-name">Fifo</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        surface<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这里我们要为 surface 定义一份配置，以此确定 surface 如何创建其底层的 <code>SurfaceTexture</code>。我们会等到后续介绍 <code>render</code> 函数时再讨论 <code>SurfaceTexture</code> 的问题。现在我们先来看看这份配置中的字段。</p> <p><code>usage</code> 字段用于定义应如何使用 <code>SurfaceTextures</code>。<code>RENDER_ATTACHMENT</code> 表明纹理将用来上屏（我们将在后面介绍其他的 <code>TextureUsage</code>）。</p> <p><code>format</code> 字段定义了 <code>SurfaceTexture</code> 在 GPU 上的存储方式。不同的显示器会偏好不同的格式。为此我们使用 <code>surface.get_preferred_format(&amp;adapter)</code> 来基于当前显示器计算出对应的最佳格式。</p> <p><code>width</code> 和 <code>height</code> 是 <code>SurfaceTexture</code> 的宽度和高度（单位为像素）。它们通常应等于窗口的宽度和高度。</p> <div class="warning">
请确保 <code>SurfaceTexture</code> 的宽高不为 0，否则可能导致应用崩溃。
</div> <p><code>present_mode</code> 使用 <code>wgpu::PresentMode</code> 枚举值来确定应如何将 surface 同步到显示器上。对于我们所选择的 <code>FIFO</code> 选项，其含义是将显示速率限制为显示器的帧速率。实际上这就是 VSync，也是移动设备上最理想的模式。对于其他选项可以<a href="https://docs.rs/wgpu/0.12.0/wgpu/enum.PresentMode.html" target="_blank" rel="noopener noreferrer">参见文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>现在我们已经配置好了 surface，这样就可以在方法的末尾添加下面这些新字段了：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            surface<span class="token punctuation">,</span>
            device<span class="token punctuation">,</span>
            queue<span class="token punctuation">,</span>
            config<span class="token punctuation">,</span>
            size<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在进入事件循环前，我们需要在主方法中做如下调用：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// State::new 使用了异步代码，所以我们需等待其完成</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> state <span class="token operator">=</span> <span class="token namespace">pollster<span class="token punctuation">::</span></span><span class="token function">block_on</span><span class="token punctuation">(</span><span class="token class-name">State</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>window<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="note"><p>你可以用形如 <a href="https://docs.rs/async_std" target="_blank" rel="noopener noreferrer">async_std<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 和 <a href="https://docs.rs/tokio" target="_blank" rel="noopener noreferrer">tokio<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 这样较重的库来让 main 函数支持异步，这样就可以 await 某个 future 了。笔者选择不使用这些库，是因为本教程并非涉及异步应用开发，并且由 wgpu 所创建的 future 无需<a href="https://rust-lang.github.io/async-book/08_ecosystem/00_chapter.html#determining-ecosystem-compatibility" target="_blank" rel="noopener noreferrer">特殊执行器的支持<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。因此我们只需要一些方法来与 wgpu 的异步函数进行交互，而 <a href="https://docs.rs/pollster" target="_blank" rel="noopener noreferrer">pollster crate<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 就足以满足这个需求了。</p></div> <h2 id="resize"><a href="#resize" class="header-anchor">#</a> resize()</h2> <p>如果想支持调整应用的窗口大小，我们需要在每次窗口尺寸改变时重新配置 <code>surface</code>。正因为如此，我们才同时存储了物理 <code>size</code> 和用于配置 <code>surface</code> 的 <code>config</code>。有了它们后，resize 方法的实现就非常简单了：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// impl State</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">resize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> new_size<span class="token punctuation">:</span> <span class="token namespace">winit<span class="token punctuation">::</span>dpi<span class="token punctuation">::</span></span><span class="token class-name">PhysicalSize</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> new_size<span class="token punctuation">.</span>width <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> new_size<span class="token punctuation">.</span>height <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>size <span class="token operator">=</span> new_size<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>width <span class="token operator">=</span> new_size<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>height <span class="token operator">=</span> new_size<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>surface<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>device<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上述代码与最初的 <code>surface</code> 配置过程没有实质性的差异，故此处不再赘述。</p> <p>在 <code>main()</code> 函数的事件循环中，我们需要在以下事件发生时调用该方法：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">match</span> event <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token punctuation">}</span> <span class="token keyword">if</span> window_id <span class="token operator">==</span> window<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">if</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">match</span> event <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>

            <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">Resized</span><span class="token punctuation">(</span>physical_size<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                state<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token operator">*</span>physical_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">ScaleFactorChanged</span> <span class="token punctuation">{</span> new_inner_size<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// new_inner_size 是 &amp;&amp;mut 类型，因此需要解引用两次</span>
                state<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>new_inner_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="input"><a href="#input" class="header-anchor">#</a> input()</h2> <p><code>input()</code> 返回一个 <code>bool</code> 来表示某事件是否已被完全处理。如果该方法返回 <code>true</code>，主循环将不再继续处理该事件。</p> <p>由于目前还没有任何需要捕获的事件，现在我们只需在此返回 false 即可：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// impl State</span>
<span class="token keyword">fn</span> <span class="token function-definition function">input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> event<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">WindowEvent</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
    <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另外我们还需要在事件循环中再多做一点工作。再加上之前的修改，最后的事件循环看起来应该像这样：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// main()</span>
event_loop<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>event<span class="token punctuation">,</span> _<span class="token punctuation">,</span> control_flow<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">match</span> event <span class="token punctuation">{</span>
        <span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">WindowEvent</span> <span class="token punctuation">{</span>
            <span class="token keyword">ref</span> event<span class="token punctuation">,</span>
            window_id<span class="token punctuation">,</span>
        <span class="token punctuation">}</span> <span class="token keyword">if</span> window_id <span class="token operator">==</span> window<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">if</span> <span class="token operator">!</span>state<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// UPDATED!</span>
            <span class="token keyword">match</span> event <span class="token punctuation">{</span>
                <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">CloseRequested</span>
                <span class="token operator">|</span> <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">KeyboardInput</span> <span class="token punctuation">{</span>
                    input<span class="token punctuation">:</span>
                        <span class="token class-name">KeyboardInput</span> <span class="token punctuation">{</span>
                            state<span class="token punctuation">:</span> <span class="token class-name">ElementState</span><span class="token punctuation">::</span><span class="token class-name">Pressed</span><span class="token punctuation">,</span>
                            virtual_keycode<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token class-name">VirtualKeyCode</span><span class="token punctuation">::</span><span class="token class-name">Escape</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token punctuation">..</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token punctuation">..</span>
                <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token operator">*</span>control_flow <span class="token operator">=</span> <span class="token class-name">ControlFlow</span><span class="token punctuation">::</span><span class="token class-name">Exit</span><span class="token punctuation">,</span>
                <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">Resized</span><span class="token punctuation">(</span>physical_size<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    state<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token operator">*</span>physical_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">WindowEvent</span><span class="token punctuation">::</span><span class="token class-name">ScaleFactorChanged</span> <span class="token punctuation">{</span> new_inner_size<span class="token punctuation">,</span> <span class="token punctuation">..</span> <span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    state<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>new_inner_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="update"><a href="#update" class="header-anchor">#</a> update()</h2> <p>我们还没有东西需要更新，所以在此留空即可：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">update</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// remove `todo!()`</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到后续需要在各种对象之间跳转时，我们会在这里添加一些代码。</p> <h2 id="render"><a href="#render" class="header-anchor">#</a> render()</h2> <p>这里就是奇迹发生的地方了。首先我们需要获得一帧以供渲染：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// impl State</span>

<span class="token keyword">fn</span> <span class="token function-definition function">render</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> output <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>surface<span class="token punctuation">.</span><span class="token function">get_current_texture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre></div><p><code>get_current_texture</code> 函数会等待 <code>surface</code> 提供一个新的 <code>SurfaceTexture</code> 以用于渲染。我们将把它储存在 <code>output</code> 中以便后续使用。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>    <span class="token keyword">let</span> view <span class="token operator">=</span> output<span class="token punctuation">.</span>texture<span class="token punctuation">.</span><span class="token function">create_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDescriptor</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这一行创建了一个使用默认配置的 <code>TextureView</code>，这样做是为了控制渲染代码与纹理之间的交互。</p> <p>我们还需要创建一个 <code>CommandEncoder</code> 来创建实际发送到 GPU 上的命令。大多数现代图形框架会将发送到 GPU 之前的命令存储在一个命令缓冲区之中。<code>encoder</code> 就建立了一个这样的命令缓冲区，其中的数据可以发送给 GPU。</p> <div class="language-rust extra-class"><pre class="language-rust"><code>    <span class="token keyword">let</span> <span class="token keyword">mut</span> encoder <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span>device<span class="token punctuation">.</span><span class="token function">create_command_encoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CommandEncoderDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Encoder&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>现在我们可以真正开始执行期盼已久的清屏操作了。我们需要使用 <code>encoder</code> 来创建 <code>RenderPass</code>。这个 <code>RenderPass</code> 拥有所有供实际绘图的方法。由于创建 <code>RenderPass</code> 的代码嵌套较深，所以在讨论其中细节之前，我们先把它完整地复制到这里：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> _render_pass <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassColorAttachment</span> <span class="token punctuation">{</span>
                view<span class="token punctuation">:</span> <span class="token operator">&amp;</span>view<span class="token punctuation">,</span>
                resolve_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                ops<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>
                    load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Clear</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Color</span> <span class="token punctuation">{</span>
                        r<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
                        g<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
                        b<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span>
                        a<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    store<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// submit 方法能传入任何实现了 IntoIter 的参数</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>queue<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token namespace">std<span class="token punctuation">::</span>iter<span class="token punctuation">::</span></span><span class="token function">once</span><span class="token punctuation">(</span>encoder<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    output<span class="token punctuation">.</span><span class="token function">present</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先让我们看一下 <code>encoder.begin_render_pass(...)</code> 外部额外的块（<code>{}</code>）。由于 <code>begin_render_pass()</code> 是以可变方式借用了 <code>encoder</code>（又称 <code>&amp;mut self</code>），因此在我们释放这个可变的借用之前，我们都不能调用 <code>encoder.finish()</code>。这个块告诉 rust 当代码离开其作用域时，释放其中的全部变量，从而释放 <code>encoder</code> 上的可变借用，从而使得我们能 <code>finish()</code> 它。如果你不喜欢 <code>{}</code>，你也可以使用 <code>drop(render_pass)</code> 来达到同样的效果。</p> <p>我们也可以通过删除 <code>{}</code> 和 <code>let _render_pass =</code> 这一行来获得同样的效果，但我们在下一份教程中需要访问 <code>_render_pass</code>，所以在这里保持这个写法就可以了。</p> <p>示例代码中的最后几行告诉 wgpu 结束对命令缓冲区的编码，并将其提交给 GPU 的渲染队列。</p> <p>我们需要再次更新事件循环来调用 <code>render</code> 方法，注意在其之前应该先调用 <code>update</code>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// main()</span>
event_loop<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>event<span class="token punctuation">,</span> _<span class="token punctuation">,</span> control_flow<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">match</span> event <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">RedrawRequested</span><span class="token punctuation">(</span>window_id<span class="token punctuation">)</span> <span class="token keyword">if</span> window_id <span class="token operator">==</span> window<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            state<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">match</span> state<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
                <span class="token comment">// 如果发生上下文丢失，就重新配置 surface</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceError</span><span class="token punctuation">::</span><span class="token class-name">Lost</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">// 系统内存不足，此时应该退出</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceError</span><span class="token punctuation">::</span><span class="token class-name">OutOfMemory</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">*</span>control_flow <span class="token operator">=</span> <span class="token class-name">ControlFlow</span><span class="token punctuation">::</span><span class="token class-name">Exit</span><span class="token punctuation">,</span>
                <span class="token comment">// 所有其他错误（如过时、超时等）都应在下一帧解决</span>
                <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token macro property">eprintln!</span><span class="token punctuation">(</span><span class="token string">&quot;{:?}&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Event</span><span class="token punctuation">::</span><span class="token class-name">MainEventsCleared</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 除非手动请求，否则 RedrawRequested 只会触发一次</span>
            window<span class="token punctuation">.</span><span class="token function">request_redraw</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>基于以上代码，你应该能获得类似这样的效果：</p> <p><img src="data:image/png;base64,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IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAOiECAADUCREAAKBOiAAAAHVCBAAAqBMiAABAnRABAADqhAgAAFAnRAAAgDohAgAA1AkRAACgTogAAAB1QgQAAKgTIgAAQJ0QAQAA6oQIAABQJ0QAAIA6IQIAANQJEQAAoE6IAAAAdUIEAACoEyIAAECdEAEAAOqECAAAUCdEAACAuqkk2b5udKHnAAAAfob8P4Fe1tYvSjndAAAAAElFTkSuQmCC" alt="带蓝色背景的窗口"></p> <h2 id="关于-renderpassdescriptor"><a href="#关于-renderpassdescriptor" class="header-anchor">#</a> 关于 RenderPassDescriptor</h2> <p>一些读者可能光看一遍代码就能知道 RenderPassDescriptor 背后的细节，但如果笔者不把它介绍一遍，那就有些失职了。让我们再看一下代码：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>
    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一个 <code>RenderPassDescriptor</code> 只带有三个字段：<code>label</code>、<code>color_attachments</code> 和 <code>depth_stencil_attachment</code>。其中 <code>color_attachments</code> 定义了颜色所应绘制到的目标。此处我们传入之前创建的 <code>TextureView</code> 来确保渲染到屏幕上。</p> <p>我们后面会用到 <code>depth_stencil_attachment</code>，但现在将其设置为 <code>None</code> 即可。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassColorAttachment</span> <span class="token punctuation">{</span>
    view<span class="token punctuation">:</span> <span class="token operator">&amp;</span>view<span class="token punctuation">,</span>
    resolve_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
    ops<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>
        load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Clear</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Color</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
            g<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
            b<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span>
            a<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        store<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>RenderPassColorAttachment</code> 有一个 <code>view</code> 字段，它用于告知 wgpu 应将颜色存储到哪个纹理。对现在的例子而言，这里应当传入我们用 <code>surface.get_current_texture()</code> 所创建的 <code>view</code>。这意味着后续在这个 attachment 上所绘制的颜色都会上屏。</p> <p><code>resolve_target</code> 是用于接收多重采样解析后所输出内容的纹理。除非启用了多重采样，否则这里获得的效果应当与 <code>view</code> 相同。我们无需进行这一配置，故将其保留为 <code>None</code> 即可。</p> <p><code>ops</code> 字段需要接收一个 <code>wpgu::Operations</code> 对象，它用于告知 wgpu 应如何处理屏幕上的颜色（此处由 <code>view</code> 确定）。<code>load</code> 字段告诉 wgpu 该如何处理存储在前一帧的颜色，对应到我们目前的设定，即为用蓝色清屏。<code>store</code> 字段用于告知 wgpu 是否应将渲染的结果存储到 <code>TextureView</code> 下层的 <code>Texture</code>（在这个例子中是 <code>SurfaceTexture</code>）。由于我们确实希望存储渲染结果，因此这里我们使用 <code>true</code>。有些时候是不需要这么做的。</p> <div class="note"><p>如果屏幕会被物体完全覆盖，那么不清屏的情况也是很常见的。但如果你的场景并未覆盖整个屏幕，那就需要用到上面这部分代码。</p> <p><img src="/learn-wgpu-cn/assets/img/no-clear.753f913f.png" alt="./no-clear.png"></p></div> <h2 id="关于-validation-error"><a href="#关于-validation-error" class="header-anchor">#</a> 关于 Validation Error</h2> <p>如果 wgpu 在你的设备上使用 Vulkan，那么它可能在旧版 Vulkan SDK 上遇到 Validation Error。你应该至少使用 <code>1.2.182</code> 版本的 SDK，因为旧版可能产生一些误报。如果错误持续存在，也可能说明你遇到了 wgpu 的 bug。你可以在 <a href="https://github.com/gfx-rs/wgpu" target="_blank" rel="noopener noreferrer">https://github.com/gfx-rs/wgpu<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 提交相应的 issue。</p> <h2 id="小测验"><a href="#小测验" class="header-anchor">#</a> 小测验</h2> <p>修改 <code>input()</code> 方法来捕获鼠标事件，并使用该方法来更新清屏颜色。<em>提示：你可能需要使用 <code>WindowEvent::CursorMoved</code></em>。</p> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/beginner/tutorial2-surface/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/24/2022, 10:02:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu-cn/beginner/tutorial1-window/" class="prev">
          依赖与窗口
        </a></span> <span class="next"><a href="/learn-wgpu-cn/beginner/tutorial3-pipeline/">
          使用 Pipeline
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu-cn/assets/js/app.4ff5359b.js" defer></script><script src="/learn-wgpu-cn/assets/js/4.7de995c5.js" defer></script><script src="/learn-wgpu-cn/assets/js/14.27582479.js" defer></script><script src="/learn-wgpu-cn/assets/js/25.997fcfd2.js" defer></script>
  </body>
</html>
