<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实例化绘制 | 学习 Wgpu</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.4.0">
    
    <meta property="article:modified_time" content="2022-04-30T14:50:47.000Z"><meta property="og:site_name" content="学习 Wgpu"><meta property="og:title" content="实例化绘制"><meta property="og:type" content="website"><meta property="og:url" content="/beginner/tutorial7-instancing/"><meta name="twitter:title" content="实例化绘制"><meta name="twitter:url" content="/beginner/tutorial7-instancing/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:data2" content="Benjamin Hansen"><meta name="twitter:creator" content="https://twitter.com/sotrh760">
    <link rel="preload" href="/learn-wgpu-cn/assets/css/0.styles.2f5dce02.css" as="style"><link rel="preload" href="/learn-wgpu-cn/assets/js/app.4a62b3f5.js" as="script"><link rel="preload" href="/learn-wgpu-cn/assets/js/4.9ddd2a75.js" as="script"><link rel="preload" href="/learn-wgpu-cn/assets/js/19.f3f8b412.js" as="script"><link rel="preload" href="/learn-wgpu-cn/assets/js/25.5a7a1f31.js" as="script"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/1.e1054b07.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/10.1b6d1cf6.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/11.1001c632.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/12.7e1fa0ed.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/13.c591e8de.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/14.1821141e.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/15.795372a4.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/16.14679006.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/17.36012420.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/18.3941048f.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/2.ce803252.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/20.140d2648.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/21.a801933f.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/22.d1c5beb9.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/23.ffb83767.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/24.6a0d1e12.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/26.a5048f3d.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/27.14e287f6.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/28.0d853b3b.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/29.c45319b3.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/30.f4b97050.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/31.ab88ef7b.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/32.21765d0f.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/33.4daba1cc.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/34.9d2cb00a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/35.45887274.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/36.c0c5124a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/5.9e56ad9a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/6.8eb3b610.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/7.e1535c20.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/8.a6ef1f77.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/9.62cbd082.js">
    <link rel="stylesheet" href="/learn-wgpu-cn/assets/css/0.styles.2f5dce02.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu-cn/" class="home-link router-link-active"><!----> <span class="site-name">学习 Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu-cn/" class="sidebar-link">介绍</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>入门</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-cn/beginner/tutorial1-window/" class="sidebar-link">依赖与窗口</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial2-surface/" class="sidebar-link">使用 Surface</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial3-pipeline/" class="sidebar-link">使用 Pipeline</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial4-buffer/" class="sidebar-link">顶点缓冲区与索引缓冲区</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial5-textures/" class="sidebar-link">纹理与 BindGroup</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial6-uniforms/" class="sidebar-link">Uniform 缓冲区与 3D 相机</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial7-instancing/" class="active sidebar-link">实例化绘制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial7-instancing/#实例缓冲区" class="sidebar-link">实例缓冲区</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial7-instancing/#小测验" class="sidebar-link">小测验</a></li></ul></li><li><a href="/learn-wgpu-cn/beginner/tutorial8-depth/" class="sidebar-link">深度缓冲区</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial9-models/" class="sidebar-link">加载模型</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-cn/intermediate/tutorial10-lighting/" class="sidebar-link">🚧 处理光照效果</a></li><li><a href="/learn-wgpu-cn/intermediate/tutorial11-normals/" class="sidebar-link">🚧 法线贴图</a></li><li><a href="/learn-wgpu-cn/intermediate/tutorial12-camera/" class="sidebar-link">🚧 更好的相机</a></li><li><a href="/learn-wgpu-cn/intermediate/tutorial13-threading/" class="sidebar-link">🚧 基于 Wgpu 和 Rayon 的多线程</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>案例展示</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>更新动态</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="实例化绘制"><a href="#实例化绘制" class="header-anchor">#</a> 实例化绘制</h1> <p>现在我们的场景还非常简单，其中只有一个 <code>(0,0,0)</code> 为中心的物体。如果想绘制更多物体该怎么办呢？这时可以使用实例化绘制（instancing）。</p> <p>实例化绘制允许我们以不同的属性（如位置、方向、大小、颜色等）多次绘制同一个对象。有多种方法可以实现实例化绘制，其中一种方法是在 uniform 缓冲区中加入这些属性，并在绘制对象的每个实例前更新它。</p> <p>但由于性能原因，并不推荐使用这种方法。因为如果对每个实例更新 uniform 缓冲区，需要逐帧创建多份缓冲区的拷贝。除此之外，更新 uniform 缓冲区时还需要创建一个新的缓冲区来存储更新后的数据，这就在 draw call 之间浪费了很多时间。</p> <p>所幸如果查阅 <a href="https://docs.rs/wgpu/0.12.0/wgpu/struct.RenderPass.html#method.draw_indexed" target="_blank" rel="noopener noreferrer">wgpu 文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中 <code>draw_indexed</code> 函数的参数，可以找到解决这一问题的方式：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">draw_indexed</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
    indices<span class="token punctuation">:</span> <span class="token class-name">Range</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    base_vertex<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    instances<span class="token punctuation">:</span> <span class="token class-name">Range</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span> <span class="token comment">// &lt;-- 在这里</span>
<span class="token punctuation">)</span>
</code></pre></div><p>参数 <code>instances</code> 是 <code>Range&lt;u32&gt;</code> 类型，它告诉 GPU 应绘制多少份模型的副本（或者说实例）。目前我们指定的是 <code>0...1</code>，表示告诉 GPU 绘制一次模型。如果使用 <code>0...5</code>，代码将绘制 5 个实例。</p> <p><code>instances</code> 的 <code>Range&lt;u32&gt;</code> 类型看起来可能有点奇怪，因为如果使用 <code>1...2</code> 的参数，效果也一样是绘制出对象的一个实例。所以似乎直接使用 <code>u32</code> 会更简单？但注意这里使用 range 的原因在于有时我们不想画出<strong>所有</strong>的对象，而只想画出其中某一部分，因为其他对象可能不出现在这一帧中，或者由于调试而需检查某组特定的实例。</p> <p>现在我们已经知道如何绘制一个对象的多个实例，那么如何告诉 wgpu 要绘制什么特定的实例呢？这需要用到实例缓冲区这一概念。</p> <h2 id="实例缓冲区"><a href="#实例缓冲区" class="header-anchor">#</a> 实例缓冲区</h2> <p>我们将以类似创建 uniform 缓冲区的方式来创建实例缓冲区。首先创建一个名为 <code>Instance</code> 的 struct：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// main.rs</span>
<span class="token comment">// ...</span>

<span class="token comment">// NEW!</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Instance</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    rotation<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="note"><p><code>Quaternion</code>（四元数）是一种通常用于表示旋转的数学结构。它背后的数学原理有些超纲（涉及虚数和 4D 空间），所以这里不会详细介绍。如果你真的想深入了解这一概念，<a href="https://mathworld.wolfram.com/Quaternion.html" target="_blank" rel="noopener noreferrer">这里有一篇 Wolfram Alpha 的文章<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></div> <p>在着色器中直接使用这些值会有点麻烦，因为四元数并未在 WGSL 中直接建模。笔者认为在着色器中做相关运算并非最佳实践，所以这里把 <code>Instance</code> 数据转换成矩阵，并将其存储在一个名为 <code>InstanceRaw</code> 的 struct 中：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// NEW!</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone, bytemuck::Pod, bytemuck::Zeroable)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">InstanceRaw</span> <span class="token punctuation">{</span>
    model<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这就是将进入 <code>wgpu::Buffer</code> 的数据。建立这一区分后，即可方便地更新 <code>Instance</code> 而无需操作矩阵，只要在绘制前更新 raw 数据即可。</p> <p>下面在 <code>Instance</code> 上增加一个方法，实现其到 <code>InstanceRaw</code> 的转换：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// NEW!</span>
<span class="token keyword">impl</span> <span class="token class-name">Instance</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">to_raw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">InstanceRaw</span> <span class="token punctuation">{</span>
        <span class="token class-name">InstanceRaw</span> <span class="token punctuation">{</span>
            model<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">from_translation</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>position<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在我们需要给 <code>State</code> 添加 <code>instances</code> 和 <code>instance_buffer</code> 两个字段：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    instances<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Instance</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    instance_buffer<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Buffer</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>cgmath</code> crate 使用 trait 来提供对其中如 <code>Vector3</code> 等 stuct 常用的数学运算方法，而这些 trait 必须在调用这些方法前导入。为方便起见，crate 内的 <code>prelude</code> 模块在导入时提供了最常用的一些扩展 crate。</p> <p>要导入 prelude 模块，将这一行放在 <code>main.rs</code> 顶部即可：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">cgmath<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
</code></pre></div><p>我们将在 <code>new()</code> 中创建实例。为了方便理解，这里会设定一些常数。我们会绘制 10x10 的实例，将它们均匀地隔开：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">const</span> <span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">:</span> <span class="token keyword">u32</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">INSTANCE_DISPLACEMENT</span><span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token constant">NUM_INSTANCES_PER_ROW</span> <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token constant">NUM_INSTANCES_PER_ROW</span> <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>现在可以开始实例化绘制了：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Window</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">let</span> instances <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>z<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> position <span class="token operator">=</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> x <span class="token keyword">as</span> <span class="token keyword">f32</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> z <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token punctuation">}</span> <span class="token operator">-</span> <span class="token constant">INSTANCE_DISPLACEMENT</span><span class="token punctuation">;</span>

                <span class="token keyword">let</span> rotation <span class="token operator">=</span> <span class="token keyword">if</span> position<span class="token punctuation">.</span><span class="token function">is_zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 需要这行特殊处理，这样在 (0, 0, 0) 的物体不会被缩放到 0</span>
                    <span class="token comment">// 因为错误的四元数会影响到缩放</span>
                    <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span><span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token punctuation">::</span><span class="token function">unit_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Deg</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Deg</span><span class="token punctuation">(</span><span class="token number">45.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token class-name">Instance</span> <span class="token punctuation">{</span>
                    position<span class="token punctuation">,</span> rotation<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在我们有了数据，可以创建实际的 <code>instance_buffer</code> 了：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> instance_data <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Instance</span><span class="token punctuation">::</span>to_raw<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> instance_buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer_init</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span>util<span class="token punctuation">::</span></span><span class="token class-name">BufferInitDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Instance Buffer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        contents<span class="token punctuation">:</span> <span class="token namespace">bytemuck<span class="token punctuation">::</span></span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>instance_data<span class="token punctuation">)</span><span class="token punctuation">,</span>
        usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferUsages</span><span class="token punctuation">::</span><span class="token constant">VERTEX</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后需要为 <code>InstanceRaw</code> 创建一个新的 <code>VertexBufferLayout</code>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">InstanceRaw</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">desc</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>mem<span class="token punctuation">;</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span> <span class="token punctuation">{</span>
            array_stride<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">InstanceRaw</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
            <span class="token comment">// 我们需要从把 Vertex 的 step mode 切换为 Instance</span>
            <span class="token comment">// 这样着色器只有在开始处理一次新实例化绘制时，才会接受下一份实例</span>
            step_mode<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexStepMode</span><span class="token punctuation">::</span><span class="token class-name">Instance</span><span class="token punctuation">,</span>
            attributes<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token comment">// 虽然顶点着色器现在只使用位置 0 和 1，但在后面的教程中，我们将对 Vertex 使用位置 2、3 和 4</span>
                    <span class="token comment">// 因此我们将从 5 号 slot 开始，以免在后面导致冲突</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 一个 mat4 需要占用 4 个顶点 slot，因为严格来说它是 4 个vec4</span>
                <span class="token comment">// 我们需要为每个 vec4 定义一个 slot，并在着色器中重新组装出 mat4</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们需要将这个描述符添加到渲染管线中，以便在渲染时使用：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> render_pipeline <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineDescriptor</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    vertex<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexState</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// UPDATED!</span>
        buffers<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Vertex</span><span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">InstanceRaw</span><span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>也别忘了返回新增的变量：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// NEW!</span>
    instances<span class="token punctuation">,</span>
    instance_buffer<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后我们需要改动 <code>render()</code> 方法。这里需要绑定 <code>instance_buffer</code>，并改变在 <code>draw_indexed()</code> 中使用的 range，以传入实例的数量：</p> <div class="language-rust extra-class"><pre class="language-rust"><code>render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>diffuse_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>camera_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// NEW!</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>instance_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_index_buffer</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>index_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">IndexFormat</span><span class="token punctuation">::</span><span class="token class-name">Uint16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// UPDATED!</span>
render_pass<span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>num_indices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>instances<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> _<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="warning"><p>如果向 <code>Vec</code> 添加新的实例，请确保重新创建 <code>instance_buffer</code> 和 <code>camera_bind_group</code>，否则新实例不会正确显示。</p></div> <p>我们需要在 <code>shader.wgsl</code> 中引用新增的矩阵，这样就可以在实例中使用它。在 <code>shader.wgsl</code> 顶部添加以下内容即可：</p> <div class="language-wgsl extra-class"><pre class="language-text"><code>struct InstanceInput {
    [[location(5)]] model_matrix_0: vec4&lt;f32&gt;;
    [[location(6)]] model_matrix_1: vec4&lt;f32&gt;;
    [[location(7)]] model_matrix_2: vec4&lt;f32&gt;;
    [[location(8)]] model_matrix_3: vec4&lt;f32&gt;;
};
</code></pre></div><p>在使用矩阵前，我们需要重新组装它：</p> <div class="language-wgsl extra-class"><pre class="language-text"><code>[[stage(vertex)]]
fn vs_main(
    model: VertexInput,
    instance: InstanceInput,
) -&gt; VertexOutput {
    let model_matrix = mat4x4&lt;f32&gt;(
        instance.model_matrix_0,
        instance.model_matrix_1,
        instance.model_matrix_2,
        instance.model_matrix_3,
    );
    // Continued...
}
</code></pre></div><p>我们将在应用 <code>camera_uniform.view_proj</code> 前先应用 <code>model_matrix</code>。这是因为 <code>camera_uniform.view_proj</code> 将坐标系从<em>世界空间</em>变为<em>相机空间</em>。我们的 <code>model_matrix</code> 是一个<em>世界空间</em>中的变换，所以在使用时不希望它处于<em>相机空间</em>：</p> <div class="language-wgsl extra-class"><pre class="language-text"><code>[[stage(vertex)]]
fn vs_main(
    model: VertexInput,
    instance: InstanceInput,
) -&gt; VertexOutput {
    // ...
    var out: VertexOutput;
    out.tex_coords = model.tex_coords;
    out.clip_position = camera.view_proj * model_matrix * vec4&lt;f32&gt;(model.position, 1.0);
    return out;
}
</code></pre></div><p>完成后，应该就能看到由一片树构成的森林了！</p> <p><img src="/learn-wgpu-cn/assets/img/forest.5c5cf3ad.png" alt="./forest.png"></p> <h2 id="小测验"><a href="#小测验" class="header-anchor">#</a> 小测验</h2> <p>不妨尝试逐帧修改实例的位置和（或）旋转角。</p> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/beginner/tutorial7-instancing/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/30/2022, 2:50:47 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu-cn/beginner/tutorial6-uniforms/" class="prev">
          Uniform 缓冲区与 3D 相机
        </a></span> <span class="next"><a href="/learn-wgpu-cn/beginner/tutorial8-depth/">
          深度缓冲区
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu-cn/assets/js/app.4a62b3f5.js" defer></script><script src="/learn-wgpu-cn/assets/js/4.9ddd2a75.js" defer></script><script src="/learn-wgpu-cn/assets/js/19.f3f8b412.js" defer></script><script src="/learn-wgpu-cn/assets/js/25.5a7a1f31.js" defer></script>
  </body>
</html>
