<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å®ä¾‹åŒ–ç»˜åˆ¶ | å­¦ä¹  Wgpu</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.4.0">
    
    <meta property="article:modified_time" content="2022-04-30T14:50:47.000Z"><meta property="og:site_name" content="å­¦ä¹  Wgpu"><meta property="og:title" content="å®ä¾‹åŒ–ç»˜åˆ¶"><meta property="og:type" content="website"><meta property="og:url" content="/beginner/tutorial7-instancing/"><meta name="twitter:title" content="å®ä¾‹åŒ–ç»˜åˆ¶"><meta name="twitter:url" content="/beginner/tutorial7-instancing/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:label1" content="Written by"><meta name="twitter:data2" content="Benjamin Hansen"><meta name="twitter:creator" content="https://twitter.com/sotrh760">
    <link rel="preload" href="/learn-wgpu-cn/assets/css/0.styles.2f5dce02.css" as="style"><link rel="preload" href="/learn-wgpu-cn/assets/js/app.4a62b3f5.js" as="script"><link rel="preload" href="/learn-wgpu-cn/assets/js/4.9ddd2a75.js" as="script"><link rel="preload" href="/learn-wgpu-cn/assets/js/19.f3f8b412.js" as="script"><link rel="preload" href="/learn-wgpu-cn/assets/js/25.5a7a1f31.js" as="script"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/1.e1054b07.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/10.1b6d1cf6.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/11.1001c632.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/12.7e1fa0ed.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/13.c591e8de.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/14.1821141e.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/15.795372a4.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/16.14679006.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/17.36012420.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/18.3941048f.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/2.ce803252.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/20.140d2648.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/21.a801933f.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/22.d1c5beb9.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/23.ffb83767.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/24.6a0d1e12.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/26.a5048f3d.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/27.14e287f6.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/28.0d853b3b.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/29.c45319b3.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/30.f4b97050.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/31.ab88ef7b.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/32.21765d0f.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/33.4daba1cc.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/34.9d2cb00a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/35.45887274.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/36.c0c5124a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/5.9e56ad9a.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/6.8eb3b610.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/7.e1535c20.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/8.a6ef1f77.js"><link rel="prefetch" href="/learn-wgpu-cn/assets/js/9.62cbd082.js">
    <link rel="stylesheet" href="/learn-wgpu-cn/assets/css/0.styles.2f5dce02.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu-cn/" class="home-link router-link-active"><!----> <span class="site-name">å­¦ä¹  Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu-cn/" class="sidebar-link">ä»‹ç»</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>å…¥é—¨</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-cn/beginner/tutorial1-window/" class="sidebar-link">ä¾èµ–ä¸çª—å£</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial2-surface/" class="sidebar-link">ä½¿ç”¨ Surface</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial3-pipeline/" class="sidebar-link">ä½¿ç”¨ Pipeline</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial4-buffer/" class="sidebar-link">é¡¶ç‚¹ç¼“å†²åŒºä¸ç´¢å¼•ç¼“å†²åŒº</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial5-textures/" class="sidebar-link">çº¹ç†ä¸ BindGroup</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial6-uniforms/" class="sidebar-link">Uniform ç¼“å†²åŒºä¸ 3D ç›¸æœº</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial7-instancing/" class="active sidebar-link">å®ä¾‹åŒ–ç»˜åˆ¶</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial7-instancing/#å®ä¾‹ç¼“å†²åŒº" class="sidebar-link">å®ä¾‹ç¼“å†²åŒº</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu-cn/beginner/tutorial7-instancing/#å°æµ‹éªŒ" class="sidebar-link">å°æµ‹éªŒ</a></li></ul></li><li><a href="/learn-wgpu-cn/beginner/tutorial8-depth/" class="sidebar-link">æ·±åº¦ç¼“å†²åŒº</a></li><li><a href="/learn-wgpu-cn/beginner/tutorial9-models/" class="sidebar-link">åŠ è½½æ¨¡å‹</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>è¿›é˜¶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu-cn/intermediate/tutorial10-lighting/" class="sidebar-link">ğŸš§ å¤„ç†å…‰ç…§æ•ˆæœ</a></li><li><a href="/learn-wgpu-cn/intermediate/tutorial11-normals/" class="sidebar-link">ğŸš§ æ³•çº¿è´´å›¾</a></li><li><a href="/learn-wgpu-cn/intermediate/tutorial12-camera/" class="sidebar-link">ğŸš§ æ›´å¥½çš„ç›¸æœº</a></li><li><a href="/learn-wgpu-cn/intermediate/tutorial13-threading/" class="sidebar-link">ğŸš§ åŸºäº Wgpu å’Œ Rayon çš„å¤šçº¿ç¨‹</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ¡ˆä¾‹å±•ç¤º</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ›´æ–°åŠ¨æ€</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="å®ä¾‹åŒ–ç»˜åˆ¶"><a href="#å®ä¾‹åŒ–ç»˜åˆ¶" class="header-anchor">#</a> å®ä¾‹åŒ–ç»˜åˆ¶</h1> <p>ç°åœ¨æˆ‘ä»¬çš„åœºæ™¯è¿˜éå¸¸ç®€å•ï¼Œå…¶ä¸­åªæœ‰ä¸€ä¸ª <code>(0,0,0)</code> ä¸ºä¸­å¿ƒçš„ç‰©ä½“ã€‚å¦‚æœæƒ³ç»˜åˆ¶æ›´å¤šç‰©ä½“è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™æ—¶å¯ä»¥ä½¿ç”¨å®ä¾‹åŒ–ç»˜åˆ¶ï¼ˆinstancingï¼‰ã€‚</p> <p>å®ä¾‹åŒ–ç»˜åˆ¶å…è®¸æˆ‘ä»¬ä»¥ä¸åŒçš„å±æ€§ï¼ˆå¦‚ä½ç½®ã€æ–¹å‘ã€å¤§å°ã€é¢œè‰²ç­‰ï¼‰å¤šæ¬¡ç»˜åˆ¶åŒä¸€ä¸ªå¯¹è±¡ã€‚æœ‰å¤šç§æ–¹æ³•å¯ä»¥å®ç°å®ä¾‹åŒ–ç»˜åˆ¶ï¼Œå…¶ä¸­ä¸€ç§æ–¹æ³•æ˜¯åœ¨ uniform ç¼“å†²åŒºä¸­åŠ å…¥è¿™äº›å±æ€§ï¼Œå¹¶åœ¨ç»˜åˆ¶å¯¹è±¡çš„æ¯ä¸ªå®ä¾‹å‰æ›´æ–°å®ƒã€‚</p> <p>ä½†ç”±äºæ€§èƒ½åŸå› ï¼Œå¹¶ä¸æ¨èä½¿ç”¨è¿™ç§æ–¹æ³•ã€‚å› ä¸ºå¦‚æœå¯¹æ¯ä¸ªå®ä¾‹æ›´æ–° uniform ç¼“å†²åŒºï¼Œéœ€è¦é€å¸§åˆ›å»ºå¤šä»½ç¼“å†²åŒºçš„æ‹·è´ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ›´æ–° uniform ç¼“å†²åŒºæ—¶è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²åŒºæ¥å­˜å‚¨æ›´æ–°åçš„æ•°æ®ï¼Œè¿™å°±åœ¨ draw call ä¹‹é—´æµªè´¹äº†å¾ˆå¤šæ—¶é—´ã€‚</p> <p>æ‰€å¹¸å¦‚æœæŸ¥é˜… <a href="https://docs.rs/wgpu/0.12.0/wgpu/struct.RenderPass.html#method.draw_indexed" target="_blank" rel="noopener noreferrer">wgpu æ–‡æ¡£<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ä¸­ <code>draw_indexed</code> å‡½æ•°çš„å‚æ•°ï¼Œå¯ä»¥æ‰¾åˆ°è§£å†³è¿™ä¸€é—®é¢˜çš„æ–¹å¼ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">draw_indexed</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span>
    indices<span class="token punctuation">:</span> <span class="token class-name">Range</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    base_vertex<span class="token punctuation">:</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    instances<span class="token punctuation">:</span> <span class="token class-name">Range</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span> <span class="token comment">// &lt;-- åœ¨è¿™é‡Œ</span>
<span class="token punctuation">)</span>
</code></pre></div><p>å‚æ•° <code>instances</code> æ˜¯ <code>Range&lt;u32&gt;</code> ç±»å‹ï¼Œå®ƒå‘Šè¯‰ GPU åº”ç»˜åˆ¶å¤šå°‘ä»½æ¨¡å‹çš„å‰¯æœ¬ï¼ˆæˆ–è€…è¯´å®ä¾‹ï¼‰ã€‚ç›®å‰æˆ‘ä»¬æŒ‡å®šçš„æ˜¯ <code>0...1</code>ï¼Œè¡¨ç¤ºå‘Šè¯‰ GPU ç»˜åˆ¶ä¸€æ¬¡æ¨¡å‹ã€‚å¦‚æœä½¿ç”¨ <code>0...5</code>ï¼Œä»£ç å°†ç»˜åˆ¶ 5 ä¸ªå®ä¾‹ã€‚</p> <p><code>instances</code> çš„ <code>Range&lt;u32&gt;</code> ç±»å‹çœ‹èµ·æ¥å¯èƒ½æœ‰ç‚¹å¥‡æ€ªï¼Œå› ä¸ºå¦‚æœä½¿ç”¨ <code>1...2</code> çš„å‚æ•°ï¼Œæ•ˆæœä¹Ÿä¸€æ ·æ˜¯ç»˜åˆ¶å‡ºå¯¹è±¡çš„ä¸€ä¸ªå®ä¾‹ã€‚æ‰€ä»¥ä¼¼ä¹ç›´æ¥ä½¿ç”¨ <code>u32</code> ä¼šæ›´ç®€å•ï¼Ÿä½†æ³¨æ„è¿™é‡Œä½¿ç”¨ range çš„åŸå› åœ¨äºæœ‰æ—¶æˆ‘ä»¬ä¸æƒ³ç”»å‡º<strong>æ‰€æœ‰</strong>çš„å¯¹è±¡ï¼Œè€Œåªæƒ³ç”»å‡ºå…¶ä¸­æŸä¸€éƒ¨åˆ†ï¼Œå› ä¸ºå…¶ä»–å¯¹è±¡å¯èƒ½ä¸å‡ºç°åœ¨è¿™ä¸€å¸§ä¸­ï¼Œæˆ–è€…ç”±äºè°ƒè¯•è€Œéœ€æ£€æŸ¥æŸç»„ç‰¹å®šçš„å®ä¾‹ã€‚</p> <p>ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“å¦‚ä½•ç»˜åˆ¶ä¸€ä¸ªå¯¹è±¡çš„å¤šä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆå¦‚ä½•å‘Šè¯‰ wgpu è¦ç»˜åˆ¶ä»€ä¹ˆç‰¹å®šçš„å®ä¾‹å‘¢ï¼Ÿè¿™éœ€è¦ç”¨åˆ°å®ä¾‹ç¼“å†²åŒºè¿™ä¸€æ¦‚å¿µã€‚</p> <h2 id="å®ä¾‹ç¼“å†²åŒº"><a href="#å®ä¾‹ç¼“å†²åŒº" class="header-anchor">#</a> å®ä¾‹ç¼“å†²åŒº</h2> <p>æˆ‘ä»¬å°†ä»¥ç±»ä¼¼åˆ›å»º uniform ç¼“å†²åŒºçš„æ–¹å¼æ¥åˆ›å»ºå®ä¾‹ç¼“å†²åŒºã€‚é¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸º <code>Instance</code> çš„ structï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// main.rs</span>
<span class="token comment">// ...</span>

<span class="token comment">// NEW!</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Instance</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    rotation<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="note"><p><code>Quaternion</code>ï¼ˆå››å…ƒæ•°ï¼‰æ˜¯ä¸€ç§é€šå¸¸ç”¨äºè¡¨ç¤ºæ—‹è½¬çš„æ•°å­¦ç»“æ„ã€‚å®ƒèƒŒåçš„æ•°å­¦åŸç†æœ‰äº›è¶…çº²ï¼ˆæ¶‰åŠè™šæ•°å’Œ 4D ç©ºé—´ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä¸ä¼šè¯¦ç»†ä»‹ç»ã€‚å¦‚æœä½ çœŸçš„æƒ³æ·±å…¥äº†è§£è¿™ä¸€æ¦‚å¿µï¼Œ<a href="https://mathworld.wolfram.com/Quaternion.html" target="_blank" rel="noopener noreferrer">è¿™é‡Œæœ‰ä¸€ç¯‡ Wolfram Alpha çš„æ–‡ç« <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚</p></div> <p>åœ¨ç€è‰²å™¨ä¸­ç›´æ¥ä½¿ç”¨è¿™äº›å€¼ä¼šæœ‰ç‚¹éº»çƒ¦ï¼Œå› ä¸ºå››å…ƒæ•°å¹¶æœªåœ¨ WGSL ä¸­ç›´æ¥å»ºæ¨¡ã€‚ç¬”è€…è®¤ä¸ºåœ¨ç€è‰²å™¨ä¸­åšç›¸å…³è¿ç®—å¹¶éæœ€ä½³å®è·µï¼Œæ‰€ä»¥è¿™é‡ŒæŠŠ <code>Instance</code> æ•°æ®è½¬æ¢æˆçŸ©é˜µï¼Œå¹¶å°†å…¶å­˜å‚¨åœ¨ä¸€ä¸ªåä¸º <code>InstanceRaw</code> çš„ struct ä¸­ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// NEW!</span>
<span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone, bytemuck::Pod, bytemuck::Zeroable)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">InstanceRaw</span> <span class="token punctuation">{</span>
    model<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™å°±æ˜¯å°†è¿›å…¥ <code>wgpu::Buffer</code> çš„æ•°æ®ã€‚å»ºç«‹è¿™ä¸€åŒºåˆ†åï¼Œå³å¯æ–¹ä¾¿åœ°æ›´æ–° <code>Instance</code> è€Œæ— éœ€æ“ä½œçŸ©é˜µï¼Œåªè¦åœ¨ç»˜åˆ¶å‰æ›´æ–° raw æ•°æ®å³å¯ã€‚</p> <p>ä¸‹é¢åœ¨ <code>Instance</code> ä¸Šå¢åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œå®ç°å…¶åˆ° <code>InstanceRaw</code> çš„è½¬æ¢ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// NEW!</span>
<span class="token keyword">impl</span> <span class="token class-name">Instance</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">to_raw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">InstanceRaw</span> <span class="token punctuation">{</span>
        <span class="token class-name">InstanceRaw</span> <span class="token punctuation">{</span>
            model<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">from_translation</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>position<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>rotation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç°åœ¨æˆ‘ä»¬éœ€è¦ç»™ <code>State</code> æ·»åŠ  <code>instances</code> å’Œ <code>instance_buffer</code> ä¸¤ä¸ªå­—æ®µï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    instances<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token class-name">Instance</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    instance_buffer<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Buffer</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>cgmath</code> crate ä½¿ç”¨ trait æ¥æä¾›å¯¹å…¶ä¸­å¦‚ <code>Vector3</code> ç­‰ stuct å¸¸ç”¨çš„æ•°å­¦è¿ç®—æ–¹æ³•ï¼Œè€Œè¿™äº› trait å¿…é¡»åœ¨è°ƒç”¨è¿™äº›æ–¹æ³•å‰å¯¼å…¥ã€‚ä¸ºæ–¹ä¾¿èµ·è§ï¼Œcrate å†…çš„ <code>prelude</code> æ¨¡å—åœ¨å¯¼å…¥æ—¶æä¾›äº†æœ€å¸¸ç”¨çš„ä¸€äº›æ‰©å±• crateã€‚</p> <p>è¦å¯¼å…¥ prelude æ¨¡å—ï¼Œå°†è¿™ä¸€è¡Œæ”¾åœ¨ <code>main.rs</code> é¡¶éƒ¨å³å¯ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">cgmath<span class="token punctuation">::</span>prelude<span class="token punctuation">::</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
</code></pre></div><p>æˆ‘ä»¬å°†åœ¨ <code>new()</code> ä¸­åˆ›å»ºå®ä¾‹ã€‚ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œè¿™é‡Œä¼šè®¾å®šä¸€äº›å¸¸æ•°ã€‚æˆ‘ä»¬ä¼šç»˜åˆ¶ 10x10 çš„å®ä¾‹ï¼Œå°†å®ƒä»¬å‡åŒ€åœ°éš”å¼€ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">const</span> <span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">:</span> <span class="token keyword">u32</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">INSTANCE_DISPLACEMENT</span><span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token operator">&lt;</span><span class="token keyword">f32</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token constant">NUM_INSTANCES_PER_ROW</span> <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token constant">NUM_INSTANCES_PER_ROW</span> <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ç°åœ¨å¯ä»¥å¼€å§‹å®ä¾‹åŒ–ç»˜åˆ¶äº†ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Window</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">let</span> instances <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flat_map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>z<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token constant">NUM_INSTANCES_PER_ROW</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>x<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> position <span class="token operator">=</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> x <span class="token keyword">as</span> <span class="token keyword">f32</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> z<span class="token punctuation">:</span> z <span class="token keyword">as</span> <span class="token keyword">f32</span> <span class="token punctuation">}</span> <span class="token operator">-</span> <span class="token constant">INSTANCE_DISPLACEMENT</span><span class="token punctuation">;</span>

                <span class="token keyword">let</span> rotation <span class="token operator">=</span> <span class="token keyword">if</span> position<span class="token punctuation">.</span><span class="token function">is_zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// éœ€è¦è¿™è¡Œç‰¹æ®Šå¤„ç†ï¼Œè¿™æ ·åœ¨ (0, 0, 0) çš„ç‰©ä½“ä¸ä¼šè¢«ç¼©æ”¾åˆ° 0</span>
                    <span class="token comment">// å› ä¸ºé”™è¯¯çš„å››å…ƒæ•°ä¼šå½±å“åˆ°ç¼©æ”¾</span>
                    <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span><span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Vector3</span><span class="token punctuation">::</span><span class="token function">unit_z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Deg</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Quaternion</span><span class="token punctuation">::</span><span class="token function">from_axis_angle</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Deg</span><span class="token punctuation">(</span><span class="token number">45.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>

                <span class="token class-name">Instance</span> <span class="token punctuation">{</span>
                    position<span class="token punctuation">,</span> rotation<span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†æ•°æ®ï¼Œå¯ä»¥åˆ›å»ºå®é™…çš„ <code>instance_buffer</code> äº†ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> instance_data <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Instance</span><span class="token punctuation">::</span>to_raw<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> instance_buffer <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_buffer_init</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span>util<span class="token punctuation">::</span></span><span class="token class-name">BufferInitDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Instance Buffer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        contents<span class="token punctuation">:</span> <span class="token namespace">bytemuck<span class="token punctuation">::</span></span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>instance_data<span class="token punctuation">)</span><span class="token punctuation">,</span>
        usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferUsages</span><span class="token punctuation">::</span><span class="token constant">VERTEX</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ç„¶åéœ€è¦ä¸º <code>InstanceRaw</code> åˆ›å»ºä¸€ä¸ªæ–°çš„ <code>VertexBufferLayout</code>ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">InstanceRaw</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">desc</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span>mem<span class="token punctuation">;</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span> <span class="token punctuation">{</span>
            array_stride<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">InstanceRaw</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
            <span class="token comment">// æˆ‘ä»¬éœ€è¦ä»æŠŠ Vertex çš„ step mode åˆ‡æ¢ä¸º Instance</span>
            <span class="token comment">// è¿™æ ·ç€è‰²å™¨åªæœ‰åœ¨å¼€å§‹å¤„ç†ä¸€æ¬¡æ–°å®ä¾‹åŒ–ç»˜åˆ¶æ—¶ï¼Œæ‰ä¼šæ¥å—ä¸‹ä¸€ä»½å®ä¾‹</span>
            step_mode<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexStepMode</span><span class="token punctuation">::</span><span class="token class-name">Instance</span><span class="token punctuation">,</span>
            attributes<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    <span class="token comment">// è™½ç„¶é¡¶ç‚¹ç€è‰²å™¨ç°åœ¨åªä½¿ç”¨ä½ç½® 0 å’Œ 1ï¼Œä½†åœ¨åé¢çš„æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹ Vertex ä½¿ç”¨ä½ç½® 2ã€3 å’Œ 4</span>
                    <span class="token comment">// å› æ­¤æˆ‘ä»¬å°†ä» 5 å· slot å¼€å§‹ï¼Œä»¥å…åœ¨åé¢å¯¼è‡´å†²çª</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// ä¸€ä¸ª mat4 éœ€è¦å ç”¨ 4 ä¸ªé¡¶ç‚¹ slotï¼Œå› ä¸ºä¸¥æ ¼æ¥è¯´å®ƒæ˜¯ 4 ä¸ªvec4</span>
                <span class="token comment">// æˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ª vec4 å®šä¹‰ä¸€ä¸ª slotï¼Œå¹¶åœ¨ç€è‰²å™¨ä¸­é‡æ–°ç»„è£…å‡º mat4</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexAttribute</span> <span class="token punctuation">{</span>
                    offset<span class="token punctuation">:</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">12</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BufferAddress</span><span class="token punctuation">,</span>
                    shader_location<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
                    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexFormat</span><span class="token punctuation">::</span><span class="token class-name">Float32x4</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬éœ€è¦å°†è¿™ä¸ªæè¿°ç¬¦æ·»åŠ åˆ°æ¸²æŸ“ç®¡çº¿ä¸­ï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“æ—¶ä½¿ç”¨ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> render_pipeline <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineDescriptor</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    vertex<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexState</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// UPDATED!</span>
        buffers<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Vertex</span><span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">InstanceRaw</span><span class="token punctuation">::</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¹Ÿåˆ«å¿˜äº†è¿”å›æ–°å¢çš„å˜é‡ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">Self</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// NEW!</span>
    instances<span class="token punctuation">,</span>
    instance_buffer<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æœ€åæˆ‘ä»¬éœ€è¦æ”¹åŠ¨ <code>render()</code> æ–¹æ³•ã€‚è¿™é‡Œéœ€è¦ç»‘å®š <code>instance_buffer</code>ï¼Œå¹¶æ”¹å˜åœ¨ <code>draw_indexed()</code> ä¸­ä½¿ç”¨çš„ rangeï¼Œä»¥ä¼ å…¥å®ä¾‹çš„æ•°é‡ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code>render_pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>render_pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>diffuse_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>camera_bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>vertex_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// NEW!</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_vertex_buffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">.</span>instance_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
render_pass<span class="token punctuation">.</span><span class="token function">set_index_buffer</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>index_buffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">..</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">IndexFormat</span><span class="token punctuation">::</span><span class="token class-name">Uint16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// UPDATED!</span>
render_pass<span class="token punctuation">.</span><span class="token function">draw_indexed</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>num_indices<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token keyword">self</span><span class="token punctuation">.</span>instances<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> _<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="warning"><p>å¦‚æœå‘ <code>Vec</code> æ·»åŠ æ–°çš„å®ä¾‹ï¼Œè¯·ç¡®ä¿é‡æ–°åˆ›å»º <code>instance_buffer</code> å’Œ <code>camera_bind_group</code>ï¼Œå¦åˆ™æ–°å®ä¾‹ä¸ä¼šæ­£ç¡®æ˜¾ç¤ºã€‚</p></div> <p>æˆ‘ä»¬éœ€è¦åœ¨ <code>shader.wgsl</code> ä¸­å¼•ç”¨æ–°å¢çš„çŸ©é˜µï¼Œè¿™æ ·å°±å¯ä»¥åœ¨å®ä¾‹ä¸­ä½¿ç”¨å®ƒã€‚åœ¨ <code>shader.wgsl</code> é¡¶éƒ¨æ·»åŠ ä»¥ä¸‹å†…å®¹å³å¯ï¼š</p> <div class="language-wgsl extra-class"><pre class="language-text"><code>struct InstanceInput {
    [[location(5)]] model_matrix_0: vec4&lt;f32&gt;;
    [[location(6)]] model_matrix_1: vec4&lt;f32&gt;;
    [[location(7)]] model_matrix_2: vec4&lt;f32&gt;;
    [[location(8)]] model_matrix_3: vec4&lt;f32&gt;;
};
</code></pre></div><p>åœ¨ä½¿ç”¨çŸ©é˜µå‰ï¼Œæˆ‘ä»¬éœ€è¦é‡æ–°ç»„è£…å®ƒï¼š</p> <div class="language-wgsl extra-class"><pre class="language-text"><code>[[stage(vertex)]]
fn vs_main(
    model: VertexInput,
    instance: InstanceInput,
) -&gt; VertexOutput {
    let model_matrix = mat4x4&lt;f32&gt;(
        instance.model_matrix_0,
        instance.model_matrix_1,
        instance.model_matrix_2,
        instance.model_matrix_3,
    );
    // Continued...
}
</code></pre></div><p>æˆ‘ä»¬å°†åœ¨åº”ç”¨ <code>camera_uniform.view_proj</code> å‰å…ˆåº”ç”¨ <code>model_matrix</code>ã€‚è¿™æ˜¯å› ä¸º <code>camera_uniform.view_proj</code> å°†åæ ‡ç³»ä»<em>ä¸–ç•Œç©ºé—´</em>å˜ä¸º<em>ç›¸æœºç©ºé—´</em>ã€‚æˆ‘ä»¬çš„ <code>model_matrix</code> æ˜¯ä¸€ä¸ª<em>ä¸–ç•Œç©ºé—´</em>ä¸­çš„å˜æ¢ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨æ—¶ä¸å¸Œæœ›å®ƒå¤„äº<em>ç›¸æœºç©ºé—´</em>ï¼š</p> <div class="language-wgsl extra-class"><pre class="language-text"><code>[[stage(vertex)]]
fn vs_main(
    model: VertexInput,
    instance: InstanceInput,
) -&gt; VertexOutput {
    // ...
    var out: VertexOutput;
    out.tex_coords = model.tex_coords;
    out.clip_position = camera.view_proj * model_matrix * vec4&lt;f32&gt;(model.position, 1.0);
    return out;
}
</code></pre></div><p>å®Œæˆåï¼Œåº”è¯¥å°±èƒ½çœ‹åˆ°ç”±ä¸€ç‰‡æ ‘æ„æˆçš„æ£®æ—äº†ï¼</p> <p><img src="/learn-wgpu-cn/assets/img/forest.5c5cf3ad.png" alt="./forest.png"></p> <h2 id="å°æµ‹éªŒ"><a href="#å°æµ‹éªŒ" class="header-anchor">#</a> å°æµ‹éªŒ</h2> <p>ä¸å¦¨å°è¯•é€å¸§ä¿®æ”¹å®ä¾‹çš„ä½ç½®å’Œï¼ˆæˆ–ï¼‰æ—‹è½¬è§’ã€‚</p> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/beginner/tutorial7-instancing/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/30/2022, 2:50:47 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        â†
        <a href="/learn-wgpu-cn/beginner/tutorial6-uniforms/" class="prev">
          Uniform ç¼“å†²åŒºä¸ 3D ç›¸æœº
        </a></span> <span class="next"><a href="/learn-wgpu-cn/beginner/tutorial8-depth/">
          æ·±åº¦ç¼“å†²åŒº
        </a>
        â†’
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu-cn/assets/js/app.4a62b3f5.js" defer></script><script src="/learn-wgpu-cn/assets/js/4.9ddd2a75.js" defer></script><script src="/learn-wgpu-cn/assets/js/19.f3f8b412.js" defer></script><script src="/learn-wgpu-cn/assets/js/25.5a7a1f31.js" defer></script>
  </body>
</html>
